import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
import { BarChart, Bar, LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis, Radar, AreaChart, Area, ScatterChart, Scatter } from 'recharts';
import { Search, Filter, AlertTriangle, Clock, Settings, ArrowUpDown, Database, BarChart2, TrendingUp, Save, Printer, Download } from 'lucide-react';
import { Calendar, Users, Wrench, AlertCircle, CheckCircle, XCircle, Activity, Target, Zap, Brain, Globe, MessageSquare } from 'lucide-react';
import { Bell, BellRing, Volume2, FileText, Mail, Smartphone, Eye, EyeOff, Maximize2, Minimize2, RefreshCw } from 'lucide-react';
import { Plus, Minus, Edit, Trash2, Star, BookOpen, Camera, Mic, MapPin, Shield, Key, CloudUpload, Cpu, Gauge } from 'lucide-react';
import * as XLSX from 'xlsx';
import Papa from 'papaparse';

const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#FF0000', '#82ca9d', '#ffc658', '#ff7300', '#00ff88'];

// Расширенная структура для оборудования
const createEquipmentPassport = (equipmentCode, data = {}) => ({
  id: equipmentCode,
  code: equipmentCode,
  name: data.name || equipmentCode,
  class: data.class || 'Общепромышленное',
  subclass: data.subclass || 'Стандартное',
  
  // Паспортные данные
  manufacturer: data.manufacturer || 'Не указан',
  model: data.model || 'Не указана',
  serialNumber: data.serialNumber || 'Не указан',
  installationDate: data.installationDate || '2020-01-01',
  location: data.location || 'Цех №1',
  
  // Эксплуатационные характеристики
  operatingHours: data.operatingHours || Math.floor(Math.random() * 5000),
  lastMaintenanceDate: data.lastMaintenanceDate || '',
  nextMaintenanceDate: data.nextMaintenanceDate || '',
  
  // Показатели надежности
  mtbf: data.mtbf || 720 + Math.floor(Math.random() * 500), // Среднее время безотказной работы (часы)
  mttr: data.mttr || 2 + Math.floor(Math.random() * 6),   // Среднее время восстановления (часы)
  availability: data.availability || Math.floor(Math.random() * 15) + 85, // Коэффициент готовности (%)
  
  // История событий
  defectHistory: data.defectHistory || [],
  maintenanceHistory: data.maintenanceHistory || [],
  
  // Критичность для производства
  criticality: data.criticality || ['high', 'medium', 'low'][Math.floor(Math.random() * 3)],
  
  // Стоимостные показатели
  replacementCost: data.replacementCost || Math.floor(Math.random() * 500000) + 100000,
  maintenanceCost: data.maintenanceCost || Math.floor(Math.random() * 50000) + 10000,
  
  // Риск-оценка
  riskScore: data.riskScore || Math.floor(Math.random() * 100),
  
  // Технические характеристики
  specifications: data.specifications || {
    power: '15 кВт',
    voltage: '380 В',
    current: '25 А',
    weight: '1200 кг',
    dimensions: '2.5x1.5x2.0 м'
  },
  
  // Новые поля для улучшенной аналитики
  efficiency: data.efficiency || Math.floor(Math.random() * 20) + 75,
  energyConsumption: data.energyConsumption || Math.floor(Math.random() * 100) + 50,
  maintenanceContract: data.maintenanceContract || 'Стандартный',
  warranty: data.warranty || 'Истекла',
  spareParts: data.spareParts || []
});

// Классификация дефектов по критичности
const defectClassification = {
  critical: {
    keywords: ['авария', 'остановка', 'не работает', 'отказ', 'выход из строя', 'поломка', 'критический'],
    priority: 'Критический',
    responseTime: '2 часа',
    color: '#dc2626',
    icon: AlertTriangle,
    description: 'Требует немедленного вмешательства',
    sound: true
  },
  major: {
    keywords: ['ремонт', 'замена', 'неисправность', 'дефект', 'повреждение'],
    priority: 'Высокий',
    responseTime: '24 часа',
    color: '#f59e0b',
    icon: AlertCircle,
    description: 'Требует планового ремонта',
    sound: false
  },
  minor: {
    keywords: ['подготовка', 'настройка', 'регулировка', 'техобслуживание'],
    priority: 'Низкий',
    responseTime: '7 дней',
    color: '#059669',
    icon: Wrench,
    description: 'Плановое обслуживание',
    sound: false
  },
  operational: {
    keywords: ['в работе', 'включена', 'запуск', 'работа', 'заливка'],
    priority: 'Информация',
    responseTime: '-',
    color: '#3b82f6',
    icon: CheckCircle,
    description: 'Нормальная работа',
    sound: false
  }
};

// Расширенная система уведомлений
const NotificationSystem = {
  notifications: [],
  subscribers: [],
  
  subscribe(callback) {
    this.subscribers.push(callback);
  },
  
  unsubscribe(callback) {
    this.subscribers = this.subscribers.filter(sub => sub !== callback);
  },
  
  notify(notification) {
    const id = Date.now() + Math.random();
    const newNotification = {
      id,
      timestamp: new Date(),
      read: false,
      ...notification
    };
    
    this.notifications.unshift(newNotification);
    this.subscribers.forEach(callback => callback(this.notifications));
    
    // Звуковое уведомление
    if (notification.sound && typeof window !== 'undefined' && window.AudioContext) {
      this.playSound();
    }
    
    // Показать toast
    if (typeof document !== 'undefined') {
      this.showToast(newNotification);
    }
    
    return id;
  },
  
  playSound() {
    try {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
    } catch (error) {
      console.error('Error playing sound:', error);
    }
  },
  
  showToast(notification) {
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg transform transition-all duration-300 max-w-sm ${
      notification.type === 'critical' ? 'bg-red-600 text-white' :
      notification.type === 'warning' ? 'bg-orange-500 text-white' :
      notification.type === 'success' ? 'bg-green-600 text-white' :
      'bg-blue-600 text-white'
    }`;
    
    toast.innerHTML = `
      <div class="flex items-center space-x-2">
        <div class="font-semibold">${notification.title}</div>
        <button onclick="this.parentElement.parentElement.remove()" class="ml-auto text-white hover:text-gray-200">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
      <div class="text-sm opacity-90 mt-1">${notification.message}</div>
    `;
    
    document.body.appendChild(toast);
    
    // Автоудаление через 5 секунд
    setTimeout(() => {
      if (toast.parentElement) {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }
    }, 5000);
  }
};

// Система интеграции с оборудованием
const EquipmentIntegration = {
  // OPC UA клиент для промышленного оборудования
  opcClient: null,
  
  // Модбас TCP/RTU для ПЛК
  modbusClient: null,
  
  // WebSocket для real-time данных
  wsConnection: null,
  
  // Подключение к OPC UA серверу
  async connectOPC(serverUrl, username = '', password = '') {
    try {
      // Симуляция подключения к OPC UA
      console.log(`Подключение к OPC UA: ${serverUrl}`);
      
      // В реальной системе здесь был бы node-opcua клиент
      this.opcClient = {
        connected: true,
        serverUrl,
        nodes: new Map(),
        subscriptions: new Map()
      };
      
      // Симуляция чтения узлов
      const mockNodes = [
        { nodeId: 'ns=2;s=Equipment1.Temperature', value: 75.5, quality: 'Good' },
        { nodeId: 'ns=2;s=Equipment1.Pressure', value: 2.3, quality: 'Good' },
        { nodeId: 'ns=2;s=Equipment1.Status', value: 'Running', quality: 'Good' },
        { nodeId: 'ns=2;s=Equipment1.Speed', value: 1200, quality: 'Good' }
      ];
      
      mockNodes.forEach(node => {
        this.opcClient.nodes.set(node.nodeId, node);
      });
      
      NotificationSystem.notify({
        type: 'success',
        title: 'OPC UA подключен',
        message: `Подключение к ${serverUrl} установлено`,
        sound: false
      });
      
      return true;
    } catch (error) {
      NotificationSystem.notify({
        type: 'error',
        title: 'Ошибка OPC UA',
        message: error.message
      });
      return false;
    }
  },
  
  // Подключение к Modbus устройству
  async connectModbus(host, port = 502, unitId = 1) {
    try {
      console.log(`Подключение к Modbus: ${host}:${port}`);
      
      this.modbusClient = {
        connected: true,
        host,
        port,
        unitId,
        registers: new Map()
      };
      
      // Симуляция чтения регистров
      const mockRegisters = [
        { address: 0, value: 1250, type: 'holding' }, // Обороты
        { address: 1, value: 850, type: 'holding' },  // Температура *10
        { address: 2, value: 23, type: 'holding' },   // Давление *10
        { address: 3, value: 1, type: 'coil' }       // Статус работы
      ];
      
      mockRegisters.forEach(reg => {
        this.modbusClient.registers.set(reg.address, reg);
      });
      
      NotificationSystem.notify({
        type: 'success',
        title: 'Modbus подключен',
        message: `Подключение к ${host}:${port} установлено`
      });
      
      return true;
    } catch (error) {
      NotificationSystem.notify({
        type: 'error',
        title: 'Ошибка Modbus',
        message: error.message
      });
      return false;
    }
  },
  
  // WebSocket для real-time данных
  connectWebSocket(url) {
    try {
      // В реальной системе: this.wsConnection = new WebSocket(url);
      this.wsConnection = {
        connected: true,
        url,
        send: (data) => console.log('WS Send:', data),
        close: () => console.log('WS Closed')
      };
      
      // Симуляция получения данных
      this.startMockDataStream();
      
      NotificationSystem.notify({
        type: 'success',
        title: 'WebSocket подключен',
        message: `Real-time связь с ${url} активна`
      });
      
      return true;
    } catch (error) {
      NotificationSystem.notify({
        type: 'error',
        title: 'Ошибка WebSocket',
        message: error.message
      });
      return false;
    }
  },
  
  // Запуск симуляции потока данных
  startMockDataStream() {
    if (this.dataStreamInterval) {
      clearInterval(this.dataStreamInterval);
    }
    
    this.dataStreamInterval = setInterval(() => {
      const mockData = {
        timestamp: new Date().toISOString(),
        equipment: 'ЦМ-' + (Math.floor(Math.random() * 10) + 1),
        parameters: {
          temperature: 70 + Math.random() * 20,
          pressure: 2 + Math.random() * 1,
          speed: 1100 + Math.random() * 200,
          vibration: Math.random() * 5,
          power: 80 + Math.random() * 40
        },
        status: Math.random() > 0.9 ? 'alarm' : Math.random() > 0.7 ? 'warning' : 'normal'
      };
      
      // Отправка данных в систему
      this.processRealTimeData(mockData);
    }, 2000); // Каждые 2 секунды
  },
  
  // Обработка real-time данных
  processRealTimeData(data) {
    // Проверка критических значений
    const { parameters, equipment, status } = data;
    
    if (status === 'alarm' || parameters.temperature > 85 || parameters.pressure > 2.8) {
      NotificationSystem.notify({
        type: 'critical',
        title: 'КРИТИЧЕСКОЕ СОСТОЯНИЕ',
        message: `${equipment}: ${status === 'alarm' ? 'Аварийный сигнал' : 
          parameters.temperature > 85 ? `Перегрев ${parameters.temperature.toFixed(1)}°C` :
          `Высокое давление ${parameters.pressure.toFixed(1)} бар`}`,
        sound: true,
        equipment
      });
    } else if (status === 'warning' || parameters.temperature > 80 || parameters.vibration > 4) {
      NotificationSystem.notify({
        type: 'warning',
        title: 'Предупреждение',
        message: `${equipment}: ${parameters.temperature > 80 ? 'Повышенная температура' : 'Повышенная вибрация'}`,
        equipment
      });
    }
    
    // Добавление в историю (для subscribers)
    if (this.dataSubscribers) {
      this.dataSubscribers.forEach(callback => callback(data));
    }
  },
  
  // Подписка на данные
  subscribeToData(callback) {
    if (!this.dataSubscribers) {
      this.dataSubscribers = [];
    }
    this.dataSubscribers.push(callback);
  },
  
  // Отписка от данных
  unsubscribeFromData(callback) {
    if (this.dataSubscribers) {
      this.dataSubscribers = this.dataSubscribers.filter(sub => sub !== callback);
    }
  },
  
  // Чтение данных с OPC UA
  async readOPCNodes(nodeIds) {
    if (!this.opcClient || !this.opcClient.connected) {
      throw new Error('OPC UA не подключен');
    }
    
    const results = nodeIds.map(nodeId => {
      const node = this.opcClient.nodes.get(nodeId);
      return node ? {
        nodeId,
        value: node.value + (Math.random() - 0.5) * 0.1, // Небольшие флуктуации
        quality: node.quality,
        timestamp: new Date()
      } : null;
    }).filter(Boolean);
    
    return results;
  },
  
  // Чтение регистров Modbus
  async readModbusRegisters(addresses) {
    if (!this.modbusClient || !this.modbusClient.connected) {
      throw new Error('Modbus не подключен');
    }
    
    const results = addresses.map(addr => {
      const reg = this.modbusClient.registers.get(addr);
      return reg ? {
        address: addr,
        value: reg.type === 'coil' ? reg.value : reg.value + Math.floor((Math.random() - 0.5) * 10),
        type: reg.type,
        timestamp: new Date()
      } : null;
    }).filter(Boolean);
    
    return results;
  },
  
  // Отключение всех соединений
  disconnect() {
    if (this.dataStreamInterval) {
      clearInterval(this.dataStreamInterval);
    }
    
    this.opcClient = null;
    this.modbusClient = null;
    
    if (this.wsConnection) {
      this.wsConnection.close();
      this.wsConnection = null;
    }
    
    NotificationSystem.notify({
      type: 'info',
      title: 'Интеграция отключена',
      message: 'Все соединения с оборудованием закрыты'
    });
  }
};

// Улучшенная система экспорта
const ExportSystem = {
  async exportToPDF(data, title = 'Отчет по оборудованию') {
    // Симуляция экспорта в PDF с форматированием
    const content = this.formatDataForPDF(data);
    const blob = new Blob([content], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${title}_${new Date().toISOString().split('T')[0]}.html`;
    a.click();
    URL.revokeObjectURL(url);
    
    NotificationSystem.notify({
      type: 'success',
      title: 'Экспорт завершен',
      message: `Файл ${title} успешно экспортирован`
    });
  },
  
  async exportToExcel(data, title = 'Данные') {
    try {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(Array.isArray(data) ? data : [data]);
      XLSX.utils.book_append_sheet(wb, ws, title);
      XLSX.writeFile(wb, `${title}_${new Date().toISOString().split('T')[0]}.xlsx`);
      
      NotificationSystem.notify({
        type: 'success',
        title: 'Экспорт в Excel',
        message: `Файл ${title} готов к загрузке`
      });
    } catch (error) {
      // Fallback to CSV
      const csvContent = this.convertToCSV(data);
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${title}_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }
  },
  
  convertToCSV(data) {
    if (!data || (Array.isArray(data) && !data.length)) return '';
    
    const items = Array.isArray(data) ? data : [data];
    const headers = Object.keys(items[0]);
    const csvRows = [
      headers.join(','),
      ...items.map(row => 
        headers.map(header => 
          JSON.stringify(row[header] || '')
        ).join(',')
      )
    ];
    
    return csvRows.join('\n');
  },
  
  formatDataForPDF(data) {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <title>Отчет</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          h1 { color: #333; }
          table { width: 100%; border-collapse: collapse; margin-top: 20px; }
          th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
          th { background-color: #f2f2f2; }
          .header { text-align: center; margin-bottom: 30px; }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>Отчет по оборудованию</h1>
          <p>Дата создания: ${new Date().toLocaleString()}</p>
        </div>
        <pre>${JSON.stringify(data, null, 2)}</pre>
      </body>
      </html>
    `;
  }
};

// Расширенная поисковая система
const SearchEngine = {
  createIndex(data) {
    const index = new Map();
    
    data.forEach((item, itemIndex) => {
      const text = Object.values(item).join(' ').toLowerCase();
      const words = text.split(/\s+/);
      
      words.forEach(word => {
        if (word.length > 1) {
          if (!index.has(word)) {
            index.set(word, new Set());
          }
          index.get(word).add(itemIndex);
        }
      });
    });
    
    return index;
  },
  
  search(query, data, index) {
    if (!query.trim()) return data;
    
    const terms = query.toLowerCase().split(/\s+/);
    const results = terms.map(term => {
      const matches = new Set();
      
      // Точное совпадение
      if (index.has(term)) {
        index.get(term).forEach(idx => matches.add(idx));
      }
      
      // Частичное совпадение
      for (const [word, indices] of index) {
        if (word.includes(term) || term.includes(word)) {
          indices.forEach(idx => matches.add(idx));
        }
      }
      
      return matches;
    });
    
    // Пересечение результатов
    const finalResults = results.reduce((acc, curr) => {
      if (acc.size === 0) return curr;
      return new Set([...acc].filter(x => curr.has(x)));
    }, new Set());
    
    return [...finalResults].map(index => data[index]);
  }
};

// Улучшенная система хранения
const StorageSystem = {
  save(key, data) {
    try {
      const serialized = JSON.stringify(data);
      // Проверка размера данных
      if (serialized.length > 5 * 1024 * 1024) { // 5MB limit
        console.warn('Data size exceeds recommended limit');
      }
      localStorage.setItem(key, serialized);
      return true;
    } catch (error) {
      console.error('Ошибка сохранения:', error);
      return false;
    }
  },
  
  load(key, defaultValue = null) {
    try {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : defaultValue;
    } catch (error) {
      console.error('Ошибка загрузки:', error);
      return defaultValue;
    }
  },
  
  remove(key) {
    try {
      localStorage.removeItem(key);
      return true;
    } catch (error) {
      console.error('Ошибка удаления:', error);
      return false;
    }
  },
  
  clear() {
    try {
      const keysToKeep = ['theme_preference', 'user_settings'];
      const allKeys = Object.keys(localStorage);
      
      allKeys.forEach(key => {
        if (!keysToKeep.includes(key)) {
          localStorage.removeItem(key);
        }
      });
      
      return true;
    } catch (error) {
      console.error('Ошибка очистки:', error);
      return false;
    }
  }
};

// Расширенная AI система рекомендаций
const AISystem = {
  async analyzeEquipment(equipment, events) {
    // Симуляция AI анализа
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    const recommendations = [];
    const riskFactors = [];
    
    // Анализ частоты отказов
    const criticalEvents = events.filter(e => e.severity === 'high');
    if (criticalEvents.length > 2) {
      recommendations.push({
        type: 'critical',
        confidence: 0.94,
        action: 'Немедленная замена критических компонентов',
        cost: equipment.replacementCost * 0.4,
        timeline: '2-3 дня',
        impact: 'Предотвращение полного отказа оборудования'
      });
      riskFactors.push('Высокая частота критических отказов');
    }
    
    // Анализ доступности
    if (equipment.availability < 85) {
      recommendations.push({
        type: 'warning',
        confidence: 0.87,
        action: 'Оптимизация графика ТО и увеличение запаса ЗИП',
        cost: equipment.maintenanceCost * 1.2,
        timeline: '1-2 недели',
        impact: 'Повышение готовности на 10-15%'
      });
      riskFactors.push('Низкий коэффициент готовности');
    }
    
    // Анализ эффективности
    if (equipment.efficiency < 80) {
      recommendations.push({
        type: 'info',
        confidence: 0.82,
        action: 'Проведение энергоаудита и модернизация',
        cost: equipment.maintenanceCost * 2,
        timeline: '1-2 месяца',
        impact: 'Снижение энергопотребления на 20%'
      });
      riskFactors.push('Низкая энергоэффективность');
    }
    
    // Анализ возраста
    const age = new Date().getFullYear() - new Date(equipment.installationDate).getFullYear();
    if (age > 10) {
      recommendations.push({
        type: 'info',
        confidence: 0.75,
        action: 'Модернизация или замена оборудования',
        cost: equipment.replacementCost,
        timeline: '3-6 месяцев',
        impact: 'Снижение затрат на ТО на 40%'
      });
      riskFactors.push('Превышен срок эксплуатации');
    }
    
    // Паттерн-анализ
    const patterns = this.analyzePatterns(events);
    if (patterns.length > 0) {
      recommendations.push(...patterns.map(p => ({
        type: 'warning',
        confidence: p.confidence,
        action: p.recommendation,
        cost: equipment.maintenanceCost * 0.5,
        timeline: '1 неделя',
        impact: p.impact
      })));
    }
    
    return {
      recommendations,
      riskFactors,
      overallRisk: riskFactors.length > 2 ? 'high' : riskFactors.length > 0 ? 'medium' : 'low',
      predictedFailure: this.predictNextFailure(equipment, events),
      maintenanceOptimization: this.optimizeMaintenance(equipment, events),
      costAnalysis: this.analyzeCosts(equipment, events)
    };
  },
  
  analyzePatterns(events) {
    const patterns = [];
    
    // Анализ временных паттернов
    const timePatterns = {};
    events.forEach(event => {
      const hour = parseInt(event.eventTime.split(':')[0]);
      const timeSlot = hour < 6 ? 'night' : hour < 12 ? 'morning' : hour < 18 ? 'day' : 'evening';
      
      if (!timePatterns[timeSlot]) {
        timePatterns[timeSlot] = { total: 0, critical: 0 };
      }
      
      timePatterns[timeSlot].total++;
      if (event.severity === 'high') {
        timePatterns[timeSlot].critical++;
      }
    });
    
    // Поиск аномалий
    Object.entries(timePatterns).forEach(([slot, data]) => {
      const criticalRate = data.critical / data.total;
      if (criticalRate > 0.3) {
        patterns.push({
          type: 'time_anomaly',
          confidence: 0.85,
          recommendation: `Усилить контроль в ${slot === 'night' ? 'ночную' : slot === 'morning' ? 'утреннюю' : slot === 'day' ? 'дневную' : 'вечернюю'} смену`,
          impact: 'Снижение критических инцидентов на 30%'
        });
      }
    });
    
    return patterns;
  },
  
  predictNextFailure(equipment, events) {
    if (events.length < 2) return null;
    
    const criticalEvents = events.filter(e => e.severity === 'high');
    if (criticalEvents.length < 2) return null;
    
    const intervals = [];
    for (let i = 1; i < criticalEvents.length; i++) {
      const interval = new Date(criticalEvents[i].timestamp) - new Date(criticalEvents[i-1].timestamp);
      intervals.push(interval);
    }
    
    const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
    const stdDev = Math.sqrt(intervals.reduce((sum, interval) => sum + Math.pow(interval - avgInterval, 2), 0) / intervals.length);
    const lastEventTime = new Date(criticalEvents[criticalEvents.length - 1].timestamp);
    const predictedTime = new Date(lastEventTime.getTime() + avgInterval);
    
    // Расчет доверительного интервала
    const confidence = Math.max(0.3, Math.min(0.95, 1 - (stdDev / avgInterval)));
    
    return {
      date: predictedTime,
      confidence: confidence,
      type: 'predicted_failure',
      range: {
        min: new Date(lastEventTime.getTime() + avgInterval - stdDev),
        max: new Date(lastEventTime.getTime() + avgInterval + stdDev)
      }
    };
  },
  
  optimizeMaintenance(equipment, events) {
    // Анализ оптимального интервала ТО
    const maintenanceEvents = events.filter(e => e.eventType === 'Низкий' || e.message.includes('техобслуживание'));
    const failures = events.filter(e => e.severity === 'high');
    
    if (maintenanceEvents.length < 2 || failures.length < 1) {
      return {
        currentInterval: 30,
        recommendedInterval: 30,
        confidence: 0.5,
        savings: 0
      };
    }
    
    // Расчет текущего интервала
    const intervals = [];
    for (let i = 1; i < maintenanceEvents.length; i++) {
      intervals.push(new Date(maintenanceEvents[i].timestamp) - new Date(maintenanceEvents[i-1].timestamp));
    }
    const currentInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length / (24 * 60 * 60 * 1000); // в днях
    
    // Оптимизация на основе частоты отказов
    const failureRate = failures.length / events.length;
    const recommendedInterval = Math.round(currentInterval * (1 - failureRate * 2));
    
    return {
      currentInterval: Math.round(currentInterval),
      recommendedInterval: Math.max(7, recommendedInterval),
      confidence: 0.78,
      savings: Math.round(equipment.maintenanceCost * 0.15)
    };
  },
  
  analyzeCosts(equipment, events) {
    const criticalEvents = events.filter(e => e.severity === 'high');
    const maintenanceEvents = events.filter(e => e.eventType === 'Низкий');
    
    const totalDowntime = criticalEvents.length * equipment.mttr;
    const productionLoss = totalDowntime * 50000; // Примерная стоимость простоя в час
    const maintenanceCosts = maintenanceEvents.length * equipment.maintenanceCost;
    const repairCosts = criticalEvents.length * equipment.maintenanceCost * 3;
    
    return {
      totalCost: productionLoss + maintenanceCosts + repairCosts,
      productionLoss,
      maintenanceCosts,
      repairCosts,
      costPerHour: Math.round((maintenanceCosts + repairCosts) / equipment.operatingHours),
      recommendation: productionLoss > maintenanceCosts * 2 ? 'Увеличить частоту ТО' : 'Текущий график оптимален'
    };
  }
};

// Реальные данные за май 2025
const demoLogData = `01.05.2025, 02:30 - Диспетчер: 2:10. В работе.
01.05.2025, 03:02 - Диспетчер: 2:35. ЛОК-3 гидропресс - течь масла.
01.05.2025, 03:16 - Диспетчер: 3:15. В работе
01.05.2025, 04:35 - Диспетчер: 4:30. ЦМ-8 - устранение биения.
01.05.2025, 05:04 - Диспетчер: 5:00. В работе.
01.05.2025, 05:36 - Диспетчер: 5:25. ЛОК-3 отсутствие остывшей трубы размера соответствующего ТУ.
01.05.2025, 06:19 - Диспетчер: 6:10. УФЛ дробемет №1 - ремонт турбины.
01.05.2025, 06:51 - Диспетчер: 6:45. ЦМ-8 - замена м/ф №1048v (38 съемов - разгар раструба) на №1046v.
01.05.2025, 08:42 - Диспетчер: 7:00-7:50 ЛОК-3 отсутствие остывшей трубы размера соответствующего ТУ
01.05.2025, 09:10 - Диспетчер: 9:00 заливка
01.05.2025, 09:22 - +7 951 300-55-36: Выпуск Ду1000RJS С25 за 30.04.2025г. Заливка: план - 86шт/факт - 89шт. трубоотделочное отделение: план - 55шт/факт - 63шт. ОНЗП ОТК(Готовая продукция): план - 70шт/факт - 80шт.
01.05.2025, 09:40 - Диспетчер: 7:00-7:30 ЛЦ №3 - подготовка к работе
01.05.2025, 09:47 - Диспетчер: 8:40-9:40 ЛОК-3 отсутствие остывшей трубы размера соответствующего ТУ
01.05.2025, 10:57 - Диспетчер: 10:40 Установка дуктильности БД - ремонт металлоконструкций (сварка)
02.05.2025, 00:16 - Диспетчер: 23:05 - ЛОК 3 - отсутствие остывшей трубы. Сообщила мастер трубоотделки Головкина М. В.
02.05.2025, 00:37 - Диспетчер: 0:10 - Лямпе 2 - нет закачивания связующего " А ".
02.05.2025, 03:18 - Диспетчер: 3:05 - ЦМ № 8 - замена м/ф № 1051( 35 съёмов - ограниченный съём после т/о на м/ф № 1050.
03.05.2025, 02:10 - Диспетчер: 1:40 Стержневая машина №2 - сбой в работе нижней части
03.05.2025, 02:11 - Диспетчер: 2:00 УФЛ - нет тары под специзделия
04.05.2025, 22:52 - Диспетчер: 22:30. ОУОЦ-2 - ремонт зачистного механизма.
04.05.2025, 23:42 - Диспетчер: 23:30. ЦМ-8 - начали заливку.
05.05.2025, 01:20 - Диспетчер: 1:15..ЛОК3 - отсутствие остывшей трубы размера соответствующего ТУ.
05.05.2025, 03:10 - Диспетчер: 2:55. ЦМ-8 - устранение течи воды с бурта.
06.05.2025, 07:19 - Диспетчер: 07:10 ОЦЛ - остановка заливки (кран18 - выбивает)
07.05.2025, 07:04 - +7 904 699-39-59: ИЧТ4 7:00 Выбило масляный выключатель
08.05.2025, 07:39 - +7 980 350-08-65: Выпуск Ду1000RJS С25, ДУ 125 за прошедшие сутки. Заливка: ДУ 1000 план - 29шт/факт - 30шт. ДУ 125 план - 220шт/факт 223 шт. Брак за сутки: 1,3%
09.05.2025, 02:45 - +7 904 699-39-59: ИЧТ-2 2:45 Оторвало рычаг гидравлики на поднятие печи( требуются сварочные работы) Печь на выдачи
11.05.2025, 13:09 - Диспетчер: Прорвало трубу в плавильном отделении между ИЧТ-3 и ИЧТ-4.
11.05.2025, 13:10 - +7 904 699-39-59: 13:10 ичт 4 на аварийном охлаждении
12.05.2025, 22:43 - Диспетчер: 22:20. Произошел сбой сети интернет и телефонной связи. Не работает система видеонаблюдения и программа "1С".
14.05.2025, 13:39 - +7 920 503-28-29: 13:15 ИЧТ-2 Аварийное состояние тигля. Печь в ремонте у электриков.
15.05.2025, 11:49 - +7 904 699-39-59: ИЧТ-4. Выбивает по температуре воды 2,3,10 каналы. Перевели на 8 ступень.
16.05.2025, 13:02 - Диспетчер: 12:20 - кран № 8 - ремонт по эл/ч ( загорелся кабель ).
19.05.2025, 18:36 - Диспетчер: 18:35. Причина остановки ЦМ: заклинил опорный ролик(замена).
22.05.2025, 07:08 - Вергунов: ИЧТ-1 лопнула медная трубка!!!
23.05.2025, 18:01 - +7 904 699-39-59: Ичт 3 13:00-18:00 Выбивает по воде, хаотично по каналам 1-13. 18:00 Перевод на 16 ступень
24.05.2025, 23:06 - Диспетчер: 23:00. УФЛ выбивка - ремонт редуктора 5-т кран-балки.
25.05.2025, 22:41 - Диспетчер: 22:30 - Лямпе № 1 - переполнение резервуара с связующим № 2 ( смола ).
26.05.2025, 06:38 - Диспетчер: 6:35 - ЦМ № 8 - замена м/ф № 1041т ( 41 съём - рагар раструба, выполнение планового задания по трубе Тайтон  на м/ф № 1049 врс с-25.`;

// Функция парсинга реального формата данных
const parseLogEntryExtended = (entry) => {
  // Обновленная регулярка для нового формата: DD.MM.YYYY, HH:MM - Источник: сообщение
  const regex = /(\d{2}\.\d{2}\.\d{4}),\s(\d{2}:\d{2})\s-\s([^:]+):\s(.+)/;
  const match = entry.match(regex);
  
  if (match) {
    const message = match[4];
    
    // Извлечение времени события из сообщения
    const timeRegex = /^(\d{1,2}:\d{2})\s*(.*)/;
    const timeMatch = message.match(timeRegex);
    
    let eventTime = '';
    let cleanMessage = message;
    
    if (timeMatch) {
      eventTime = timeMatch[1];
      cleanMessage = timeMatch[2];
    }
    
    // Извлечение оборудования с учетом российских сокращений
    const equipmentRegex = /(ЦМ-?\d+|ЛОК-?\d+|ИЧТ-?\d+|УФЛ|ОЦЛ|ЛЦ\s?№?\d+|ЛЛ-?\d+|ОУОЦ-?\d+|Лямпе\s?\d+|Стержневая машина\s?\d+|Кран\s?№?\d+)/i;
    const equipmentMatch = cleanMessage.match(equipmentRegex);
    
    let equipment = '';
    if (equipmentMatch) {
      equipment = equipmentMatch[0].trim();
    }
    
    // Расширенная классификация событий для российского производства
    let eventType = 'Информация';
    let defectClass = 'operational';
    let severity = 'low';
    
    const lowerMsg = cleanMessage.toLowerCase();
    
    // Критические события
    if (lowerMsg.includes('авария') || lowerMsg.includes('остановка') || 
        lowerMsg.includes('выбивает') || lowerMsg.includes('прорвало') ||
        lowerMsg.includes('лопнула') || lowerMsg.includes('не работает') ||
        lowerMsg.includes('аварийное') || lowerMsg.includes('выход из строя')) {
      eventType = 'Критический';
      defectClass = 'critical';
      severity = 'high';
    }
    // Высокий приоритет
    else if (lowerMsg.includes('ремонт') || lowerMsg.includes('замена') || 
             lowerMsg.includes('течь') || lowerMsg.includes('нет') ||
             lowerMsg.includes('сбой') || lowerMsg.includes('неисправность')) {
      eventType = 'Высокий';
      defectClass = 'major';
      severity = 'medium';
    }
    // Плановые работы
    else if (lowerMsg.includes('подготовка') || lowerMsg.includes('очистка') ||
             lowerMsg.includes('техобслуживание') || lowerMsg.includes('профилактика') ||
             lowerMsg.includes('накопление')) {
      eventType = 'Низкий';
      defectClass = 'minor';
      severity = 'low';
    }
    // Нормальная работа
    else if (lowerMsg.includes('в работе') || lowerMsg.includes('заливка') ||
             lowerMsg.includes('план') || lowerMsg.includes('факт')) {
      eventType = 'Информация';
      defectClass = 'operational';
      severity = 'low';
    }
    
    return {
      date: match[1],
      loggingTime: match[2],
      eventTime: eventTime || match[2],
      source: match[3],
      message: cleanMessage,
      equipment,
      eventType,
      defectClass,
      severity,
      timestamp: new Date(`${match[1].split('.').reverse().join('-')}T${match[2]}:00`).getTime()
    };
  }
  
  return null;
};

const EnhancedFactoryAnalyzer = () => {
  // Основное состояние
  const [activeTab, setActiveTab] = useState('dashboard');
  const [logData, setLogData] = useState('');
  const [parsedData, setParsedData] = useState([]);
  const [filteredData, setFilteredData] = useState([]);
  const [equipmentRegistry, setEquipmentRegistry] = useState({});
  const [searchIndex, setSearchIndex] = useState(new Map());
  
  // Состояние фильтров и поиска
  const [filterOptions, setFilterOptions] = useState({
    equipment: '',
    eventType: '',
    severity: '',
    dateFrom: '',
    dateTo: '',
    searchText: ''
  });
  const [savedFilters, setSavedFilters] = useState([]);
  
  // Состояние интеграции с оборудованием
  const [integrationStatus, setIntegrationStatus] = useState({
    opcua: { connected: false, url: '', status: 'disconnected' },
    modbus: { connected: false, host: '', port: 502, status: 'disconnected' },
    websocket: { connected: false, url: '', status: 'disconnected' }
  });
  const [realTimeData, setRealTimeData] = useState([]);
  const [equipmentParameters, setEquipmentParameters] = useState({});
  const [connectionSettings, setConnectionSettings] = useState({
    opcua: { url: 'opc.tcp://localhost:4840', username: '', password: '' },
    modbus: { host: '192.168.1.100', port: 502, unitId: 1 },
    websocket: { url: 'ws://localhost:8080/equipment' }
  });
  
  // Статистика и аналитика
  const [equipmentStats, setEquipmentStats] = useState([]);
  const [eventTypeStats, setEventTypeStats] = useState([]);
  const [severityStats, setSeverityStats] = useState([]);
  const [timelineData, setTimelineData] = useState([]);
  const [recommendations, setRecommendations] = useState([]);
  const [maintenanceSchedule, setMaintenanceSchedule] = useState([]);
  const [downtimeStats, setDowntimeStats] = useState({
    today: { total: 0, equipment: {} },
    week: { total: 0, equipment: {} },
    month: { total: 0, equipment: {} },
    details: []
  });
  
  // UI состояние
  const [isLoadingAI, setIsLoadingAI] = useState(false);
  const [notifications, setNotifications] = useState([]);
  const [showNotifications, setShowNotifications] = useState(false);
  const [isDarkMode, setIsDarkMode] = useState(false);
  const [isFullscreen, setIsFullscreen] = useState(false);
  const [selectedEquipment, setSelectedEquipment] = useState(null);
  const [showEquipmentModal, setShowEquipmentModal] = useState(false);
  const [viewMode, setViewMode] = useState('cards'); // 'cards' или 'table'
  
  // AI состояние
  const [aiAnalysis, setAiAnalysis] = useState({});
  const [riskAssessment, setRiskAssessment] = useState({});
  
  // Новые состояния для улучшений
  const [realTimeMode, setRealTimeMode] = useState(false);
  const [comparisonMode, setComparisonMode] = useState(false);
  const [selectedEquipmentForComparison, setSelectedEquipmentForComparison] = useState([]);
  const fileInputRef = useRef(null);

  // Автоматический анализ новых данных
  useEffect(() => {
    if (logData && logData.trim()) {
      const debounceTimer = setTimeout(() => {
        handleAnalyzeData(logData);
      }, 1000); // Анализируем через 1 секунду после изменения
      
      return () => clearTimeout(debounceTimer);
    }
  }, [logData]);

  // Подписка на real-time данные от оборудования
  useEffect(() => {
    const handleRealTimeData = (data) => {
      setRealTimeData(prev => [data, ...prev.slice(0, 99)]); // Последние 100 записей
      
      // Обновление параметров оборудования
      setEquipmentParameters(prev => ({
        ...prev,
        [data.equipment]: {
          ...data.parameters,
          timestamp: data.timestamp,
          status: data.status
        }
      }));
      
      // Если это критическое событие, добавляем в журнал
      if (data.status === 'alarm') {
        const logEntry = `${new Date().toLocaleDateString('ru-RU')}, ${new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })} - Система: АВАРИЯ ${data.equipment} - критические параметры`;
        setLogData(prev => prev + '\n' + logEntry);
      }
    };
    
    EquipmentIntegration.subscribeToData(handleRealTimeData);
    
    return () => {
      EquipmentIntegration.unsubscribeFromData(handleRealTimeData);
    };
  }, []);

  // Автосохранение данных
  useEffect(() => {
    const saveTimer = setTimeout(() => {
      StorageSystem.save('factory_log_data', logData);
      StorageSystem.save('parsed_data', parsedData);
      StorageSystem.save('equipment_registry', equipmentRegistry);
      StorageSystem.save('saved_filters', savedFilters);
    }, 1000);
    
    return () => clearTimeout(saveTimer);
  }, [logData, parsedData, equipmentRegistry, savedFilters]);
  
  // Загрузка сохраненных данных
  useEffect(() => {
    const savedLogData = StorageSystem.load('factory_log_data', demoLogData);
    const savedParsedData = StorageSystem.load('parsed_data', []);
    const savedEquipmentRegistry = StorageSystem.load('equipment_registry', {});
    const savedFilters = StorageSystem.load('saved_filters', []);
    const savedTheme = StorageSystem.load('theme_preference', false);
    
    setLogData(savedLogData);
    setSavedFilters(savedFilters);
    setIsDarkMode(savedTheme);
    
    // Всегда перезапускаем анализ для актуальности данных
    if (savedLogData && savedLogData.trim()) {
      handleAnalyzeData(savedLogData);
    }
    
    // Подписка на уведомления
    NotificationSystem.subscribe(setNotifications);
    
    return () => {
      NotificationSystem.unsubscribe(setNotifications);
    };
  }, []);
  
  // Создание поискового индекса
  useEffect(() => {
    if (parsedData.length > 0) {
      const index = SearchEngine.createIndex(parsedData);
      setSearchIndex(index);
    }
  }, [parsedData]);
  
  // Симуляция реального времени с автоанализом
  useEffect(() => {
    if (!realTimeMode) return;
    
    const interval = setInterval(() => {
      // Генерация случайного события
      const equipment = Object.keys(equipmentRegistry);
      if (equipment.length === 0) return;
      
      const randomEquipment = equipment[Math.floor(Math.random() * equipment.length)];
      const eventTypes = ['в работе', 'ремонт', 'техобслуживание', 'авария', 'остановка'];
      const randomEvent = eventTypes[Math.floor(Math.random() * eventTypes.length)];
      
      const now = new Date();
      const newEntry = `[${now.getDate().toString().padStart(2, '0')}.${(now.getMonth() + 1).toString().padStart(2, '0')}, ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}] Диспетчер: ${now.getHours()}:${now.getMinutes()} ${randomEquipment} - ${randomEvent}`;
      
      // Добавляем новую запись к существующим данным
      setLogData(prev => {
        const newData = prev + '\n' + newEntry;
        // Автоматический анализ произойдет через useEffect выше
        return newData;
      });
      
      // Показываем уведомление о новом событии
      const parsedEntry = parseLogEntryExtended(newEntry);
      if (parsedEntry && parsedEntry.severity === 'high') {
        NotificationSystem.notify({
          type: 'critical',
          title: 'Новое критическое событие',
          message: `${parsedEntry.equipment}: ${parsedEntry.message}`,
          sound: true
        });
      }
    }, 10000); // Каждые 10 секунд
    
    return () => clearInterval(interval);
  }, [realTimeMode, equipmentRegistry]);

  // Сохранение темы
  useEffect(() => {
    StorageSystem.save('theme_preference', isDarkMode);
  }, [isDarkMode]);
  
  // Мемоизированные вычисления
  const equipmentOptions = useMemo(() => {
    return [...new Set(parsedData.map(item => item.equipment).filter(Boolean))];
  }, [parsedData]);
  
  const criticalEquipment = useMemo(() => {
    return Object.values(equipmentRegistry).filter(eq => 
      eq.criticality === 'high' || eq.availability < 85 || eq.riskScore > 70
    ).sort((a, b) => b.riskScore - a.riskScore);
  }, [equipmentRegistry]);
  
  // Основная функция анализа данных
  const handleAnalyzeData = useCallback((inputData) => {
    const lines = inputData.split('\n').filter(line => line.trim());
    const parsed = lines.map(parseLogEntryExtended).filter(entry => entry !== null);
    
    setParsedData(parsed);
    setFilteredData(parsed);
    
    // Создание реестра оборудования
    const registry = {};
    const equipmentEvents = {};
    
    parsed.forEach(entry => {
      if (entry.equipment) {
        if (!equipmentEvents[entry.equipment]) {
          equipmentEvents[entry.equipment] = [];
        }
        equipmentEvents[entry.equipment].push(entry);
        
        if (!registry[entry.equipment]) {
          registry[entry.equipment] = createEquipmentPassport(entry.equipment, {
            lastMaintenanceDate: entry.date,
            defectHistory: []
          });
        }
        
        registry[entry.equipment].defectHistory.push({
          date: entry.date,
          type: entry.eventType,
          severity: entry.severity || 'low',
          description: entry.message,
          timestamp: entry.timestamp
        });
      }
    });
    
    // Расчет показателей для каждого оборудования
    Object.entries(equipmentEvents).forEach(([equipment, events]) => {
      const criticalEvents = events.filter(e => e.severity === 'high');
      const availability = Math.max(0, 100 - (criticalEvents.length * 5));
      const riskScore = Math.min(100, criticalEvents.length * 15 + (100 - availability));
      
      registry[equipment].availability = availability;
      registry[equipment].riskScore = riskScore;
      registry[equipment].operatingHours = events.length * 24; // Примерный расчет
    });
    
    setEquipmentRegistry(registry);
    updateStatistics(parsed, registry);
    generateMaintenanceSchedule(registry);
    generateRecommendations(parsed, registry);
    
    // Проверка критических событий
    const criticalEvents = parsed.filter(entry => entry.severity === 'high');
    if (criticalEvents.length > 0) {
      NotificationSystem.notify({
        type: 'warning',
        title: 'Обнаружены критические события',
        message: `Найдено ${criticalEvents.length} критических событий, требующих внимания`,
        sound: false
      });
    }
  }, []);
  
  // Обновление статистики
  const updateStatistics = useCallback((data, registry) => {
    // Статистика по оборудованию
    const equipmentCounts = {};
    data.forEach(entry => {
      if (entry.equipment) {
        equipmentCounts[entry.equipment] = (equipmentCounts[entry.equipment] || 0) + 1;
      }
    });
    
    const equipmentData = Object.keys(equipmentCounts).map(key => ({
      name: key,
      value: equipmentCounts[key],
      criticality: registry[key]?.criticality || 'medium',
      availability: registry[key]?.availability || 95,
      riskScore: registry[key]?.riskScore || 30,
      efficiency: registry[key]?.efficiency || 85
    })).sort((a, b) => b.value - a.value);
    
    setEquipmentStats(equipmentData);
    
    // Статистика по типам событий
    const eventTypeCounts = {};
    data.forEach(entry => {
      eventTypeCounts[entry.eventType] = (eventTypeCounts[entry.eventType] || 0) + 1;
    });
    
    const eventTypeData = Object.keys(eventTypeCounts).map(key => ({
      name: key,
      value: eventTypeCounts[key]
    }));
    
    setEventTypeStats(eventTypeData);
    
    // Статистика по критичности
    const severityCounts = {};
    data.forEach(entry => {
      severityCounts[entry.severity] = (severityCounts[entry.severity] || 0) + 1;
    });
    
    const severityData = Object.keys(severityCounts).map(key => ({
      name: key === 'high' ? 'Высокая' : key === 'medium' ? 'Средняя' : 'Низкая',
      value: severityCounts[key],
      fill: key === 'high' ? '#dc2626' : key === 'medium' ? '#f59e0b' : '#059669'
    }));
    
    setSeverityStats(severityData);
    
    // Временная динамика
    const dateEventCounts = {};
    data.forEach(entry => {
      const date = entry.date;
      if (!dateEventCounts[date]) {
        dateEventCounts[date] = {
          date,
          'Критический': 0,
          'Высокий': 0,
          'Низкий': 0,
          'Информация': 0,
          total: 0
        };
      }
      dateEventCounts[date][entry.eventType]++;
      dateEventCounts[date].total++;
    });
    
    const timelineArray = Object.values(dateEventCounts);
    setTimelineData(timelineArray);
  }, []);

  // Функция расчета времени простоя
  const calculateDowntime = useCallback((data, registry) => {
    const downtimeData = {
      today: { total: 0, equipment: {} },
      week: { total: 0, equipment: {} },
      month: { total: 0, equipment: {} },
      details: []
    };

    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const weekStart = new Date(todayStart);
    weekStart.setDate(todayStart.getDate() - todayStart.getDay());
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

    // Анализ событий простоя
    data.forEach(entry => {
      if (entry.equipment && (entry.severity === 'high' || 
          entry.message.toLowerCase().includes('остановка') ||
          entry.message.toLowerCase().includes('авария') ||
          entry.message.toLowerCase().includes('не работает'))) {
        
        const entryDate = new Date(`2025-${entry.date.split('.').reverse().join('-')}`);
        const equipment = registry[entry.equipment];
        
        if (equipment) {
          // Используем MTTR как время простоя для критических событий
          const downtimeHours = equipment.mttr || 2;
          const downtimeMinutes = downtimeHours * 60;
          
          const downtimeRecord = {
            date: entry.date,
            time: entry.eventTime,
            equipment: entry.equipment,
            message: entry.message,
            downtimeHours,
            downtimeMinutes,
            severity: entry.severity,
            estimatedCost: downtimeHours * 50000 // 50000 руб/час простоя
          };
          
          downtimeData.details.push(downtimeRecord);

          // Суммарное время за день
          if (entryDate >= todayStart) {
            downtimeData.today.total += downtimeMinutes;
            downtimeData.today.equipment[entry.equipment] = 
              (downtimeData.today.equipment[entry.equipment] || 0) + downtimeMinutes;
          }

          // Суммарное время за неделю
          if (entryDate >= weekStart) {
            downtimeData.week.total += downtimeMinutes;
            downtimeData.week.equipment[entry.equipment] = 
              (downtimeData.week.equipment[entry.equipment] || 0) + downtimeMinutes;
          }

          // Суммарное время за месяц
          if (entryDate >= monthStart) {
            downtimeData.month.total += downtimeMinutes;
            downtimeData.month.equipment[entry.equipment] = 
              (downtimeData.month.equipment[entry.equipment] || 0) + downtimeMinutes;
          }
        }
      }
    });

    return downtimeData;
  }, []);

  // Генерация рекомендаций
  const generateRecommendations = useCallback(async (data, registry) => {
    const recs = [];
    
    // Расчет времени простоя
    const downtimeStats = calculateDowntime(data, registry);
    
    // Анализ критических событий
    const criticalEvents = data.filter(entry => entry.severity === 'high');
    if (criticalEvents.length > 0) {
      const equipmentWithCritical = [...new Set(criticalEvents.map(e => e.equipment).filter(Boolean))];
      
      for (const equipment of equipmentWithCritical) {
        const count = criticalEvents.filter(e => e.equipment === equipment).length;
        const equipmentData = registry[equipment];
        
        if (equipmentData) {
          const aiAnalysis = await AISystem.analyzeEquipment(equipmentData, 
            data.filter(e => e.equipment === equipment));
          
          if (aiAnalysis.recommendations.length > 0) {
            recs.push({
              priority: 'Критический',
              text: `${equipment}: ${count} критических событий. ${aiAnalysis.recommendations[0].action}`,
              equipment,
              actionRequired: true,
              estimatedCost: aiAnalysis.recommendations[0].cost,
              confidence: aiAnalysis.recommendations[0].confidence,
              source: 'AI Analysis',
              aiPrediction: aiAnalysis.predictedFailure,
              impact: aiAnalysis.recommendations[0].impact
            });
          }
        }
      }
    }

    // Рекомендации на основе времени простоя
    if (downtimeStats.today.total > 480) { // Более 8 часов простоя за день
      recs.push({
        priority: 'Критический',
        text: `Критический уровень простоя: ${Math.round(downtimeStats.today.total / 60)} часов за сегодня. Требуется срочное вмешательство.`,
        equipment: null,
        actionRequired: true,
        estimatedCost: downtimeStats.today.total * 833, // 50000 руб/час
        confidence: 0.95,
        source: 'Downtime Analysis',
        impact: 'Снижение простоев на 60%'
      });
    }

    // Сохранение статистики простоя для отображения
    setDowntimeStats(downtimeStats);
    
    // Анализ эффективности
    Object.values(registry).forEach(equipment => {
      if (equipment.availability < 85) {
        recs.push({
          priority: 'Высокий',
          text: `${equipment.code}: Готовность ${equipment.availability}%. Требуется оптимизация графика ТО.`,
          equipment: equipment.code,
          actionRequired: false,
          estimatedCost: equipment.maintenanceCost * 1.5,
          confidence: 0.8,
          source: 'Statistical Analysis',
          impact: 'Повышение готовности на 10-15%'
        });
      }
      
      if (equipment.efficiency < 80) {
        recs.push({
          priority: 'Средний',
          text: `${equipment.code}: Эффективность ${equipment.efficiency}%. Рекомендуется энергоаудит.`,
          equipment: equipment.code,
          actionRequired: false,
          estimatedCost: equipment.maintenanceCost * 0.5,
          confidence: 0.75,
          source: 'Efficiency Analysis',
          impact: 'Снижение энергопотребления на 15-20%'
        });
      }
    });
    
    if (recs.length === 0) {
      recs.push({
        priority: 'Низкий',
        text: 'Критических проблем не выявлено. Продолжайте плановое обслуживание оборудования.',
        equipment: null,
        actionRequired: false,
        estimatedCost: 0,
        confidence: 0.95,
        source: 'System Analysis'
      });
    }
    
    // Сортировка по приоритету
    const priorityOrder = { 'Критический': 0, 'Высокий': 1, 'Средний': 2, 'Низкий': 3 };
    recs.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
    
    setRecommendations(recs);
  }, []);

  // Генерация графика ТО
  const generateMaintenanceSchedule = useCallback((registry) => {
    const schedule = [];
    const today = new Date();
    
    Object.values(registry).forEach(equipment => {
      // Интервалы ТО в зависимости от критичности и состояния
      let maintenanceInterval;
      if (equipment.criticality === 'high' || equipment.availability < 85) {
        maintenanceInterval = 7; // дней
      } else if (equipment.criticality === 'medium' || equipment.availability < 90) {
        maintenanceInterval = 14;
      } else {
        maintenanceInterval = 30;
      }
      
      // Генерация записей на 60 дней вперед
      for (let i = 0; i < 60; i += maintenanceInterval) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        
        schedule.push({
          id: `${equipment.code}-${i}`,
          date: date.toISOString().split('T')[0],
          equipment: equipment.code,
          type: equipment.criticality === 'high' ? 'Критическое ТО' : 'Плановое ТО',
          priority: equipment.criticality === 'high' ? 'Высокий' : 'Средний',
          estimatedDuration: equipment.criticality === 'high' ? 8 : 4,
          responsible: equipment.criticality === 'high' ? 'Главный механик' : 'Дежурный механик',
          status: i === 0 ? 'in_progress' : 'planned',
          cost: equipment.maintenanceCost,
          description: `${equipment.criticality === 'high' ? 'Полная диагностика и ТО' : 'Стандартное ТО'} оборудования ${equipment.code}`
        });
      }
    });
    
    // Сортировка по дате
    schedule.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    setMaintenanceSchedule(schedule.slice(0, 100));
  }, []);

  // Применение фильтров с поиском
  const applyFilters = useCallback(() => {
    let filtered = [...parsedData];
    
    // Текстовый поиск
    if (filterOptions.searchText) {
      filtered = SearchEngine.search(filterOptions.searchText, filtered, searchIndex);
    }
    
    // Фильтр по оборудованию
    if (filterOptions.equipment) {
      filtered = filtered.filter(entry => 
        entry.equipment && entry.equipment.toLowerCase().includes(filterOptions.equipment.toLowerCase())
      );
    }
    
    // Фильтр по типу события
    if (filterOptions.eventType) {
      filtered = filtered.filter(entry => entry.eventType === filterOptions.eventType);
    }
    
    // Фильтр по критичности
    if (filterOptions.severity) {
      filtered = filtered.filter(entry => entry.severity === filterOptions.severity);
    }
    
    // Фильтр по дате
    if (filterOptions.dateFrom || filterOptions.dateTo) {
      filtered = filtered.filter(entry => {
        const entryDate = new Date(`2025-${entry.date.split('.').reverse().join('-')}`);
        let valid = true;
        
        if (filterOptions.dateFrom) {
          valid = valid && entryDate >= new Date(filterOptions.dateFrom);
        }
        
        if (filterOptions.dateTo) {
          valid = valid && entryDate <= new Date(filterOptions.dateTo);
        }
        
        return valid;
      });
    }
    
    setFilteredData(filtered);
  }, [parsedData, filterOptions, searchIndex]);

  // Автоприменение фильтров
  useEffect(() => {
    applyFilters();
  }, [applyFilters]);

  // Обработчики событий
  const handleFilterChange = useCallback((name, value) => {
    setFilterOptions(prev => ({ ...prev, [name]: value }));
  }, []);

  const resetFilters = useCallback(() => {
    setFilterOptions({
      equipment: '', eventType: '', severity: '', dateFrom: '', dateTo: '', searchText: ''
    });
  }, []);

  const saveCurrentFilter = useCallback(() => {
    const filterName = prompt('Введите название фильтра:');
    if (filterName) {
      const newFilter = {
        id: Date.now(),
        name: filterName,
        options: { ...filterOptions },
        createdAt: new Date().toISOString()
      };
      
      const updatedFilters = [...savedFilters, newFilter];
      setSavedFilters(updatedFilters);
      
      NotificationSystem.notify({
        type: 'success',
        title: 'Фильтр сохранен',
        message: `Фильтр "${filterName}" успешно сохранен`
      });
    }
  }, [filterOptions, savedFilters]);

  const loadSavedFilter = useCallback((filter) => {
    setFilterOptions(filter.options);
    NotificationSystem.notify({
      type: 'info',
      title: 'Фильтр применен',
      message: `Применен фильтр "${filter.name}"`
    });
  }, []);

  const handleLogDataChange = useCallback((e) => {
    setLogData(e.target.value);
  }, []);

  // AI анализ оборудования
  const handleAIAnalysis = useCallback(async (equipment) => {
    setIsLoadingAI(true);
    try {
      const events = parsedData.filter(e => e.equipment === equipment.code);
      const analysis = await AISystem.analyzeEquipment(equipment, events);
      
      setAiAnalysis(prev => ({
        ...prev,
        [equipment.code]: analysis
      }));
      
      NotificationSystem.notify({
        type: 'success',
        title: 'AI анализ завершен',
        message: `Анализ оборудования ${equipment.code} готов`,
        equipment: equipment.code
      });
      
      // Обновление рекомендаций на основе AI анализа
      if (analysis.recommendations.length > 0) {
        const aiRecs = analysis.recommendations.map(rec => ({
          priority: rec.type === 'critical' ? 'Критический' : rec.type === 'warning' ? 'Высокий' : 'Средний',
          text: `${equipment.code}: ${rec.action}`,
          equipment: equipment.code,
          actionRequired: rec.type === 'critical',
          estimatedCost: rec.cost,
          confidence: rec.confidence,
          source: 'AI Deep Analysis',
          impact: rec.impact,
          timeline: rec.timeline
        }));
        
        setRecommendations(prev => [...aiRecs, ...prev.filter(r => r.equipment !== equipment.code)]);
      }
      
    } catch (error) {
      NotificationSystem.notify({
        type: 'error',
        title: 'Ошибка AI анализа',
        message: error.message
      });
    } finally {
      setIsLoadingAI(false);
    }
  }, [parsedData]);

  // Экспорт данных
  const handleExport = useCallback(async (format, data, title) => {
    try {
      if (format === 'pdf') {
        await ExportSystem.exportToPDF(data, title);
      } else if (format === 'excel') {
        await ExportSystem.exportToExcel(data, title);
      }
    } catch (error) {
      NotificationSystem.notify({
        type: 'error',
        title: 'Ошибка экспорта',
        message: error.message
      });
    }
  }, []);

  const handleFileUpload = useCallback((event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    
    if (file.name.endsWith('.csv')) {
      reader.onload = (e) => {
        Papa.parse(e.target.result, {
          complete: (results) => {
            // Преобразование CSV в формат журнала
            const logEntries = results.data.map(row => {
              if (row.length >= 4) {
                return `[${row[0]}, ${row[1]}] ${row[2]}: ${row[3]}`;
              }
              return null;
            }).filter(Boolean).join('\n');
            
            setLogData(logEntries);
            handleAnalyzeData(logEntries);
            
            NotificationSystem.notify({
              type: 'success',
              title: 'CSV файл загружен',
              message: `Обработано ${results.data.length} записей`
            });
          },
          error: (error) => {
            NotificationSystem.notify({
              type: 'error',
              title: 'Ошибка загрузки CSV',
              message: error.message
            });
          }
        });
      };
      reader.readAsText(file);
    } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
      reader.onload = (e) => {
        try {
          const workbook = XLSX.read(e.target.result, { type: 'binary' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const data = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          
          const logEntries = data.map(row => {
            if (row.length >= 4) {
              return `[${row[0]}, ${row[1]}] ${row[2]}: ${row[3]}`;
            }
            return null;
          }).filter(Boolean).join('\n');
          
          setLogData(logEntries);
          handleAnalyzeData(logEntries);
          
          NotificationSystem.notify({
            type: 'success',
            title: 'Excel файл загружен',
            message: `Обработано ${data.length} записей`
          });
        } catch (error) {
          NotificationSystem.notify({
            type: 'error',
            title: 'Ошибка загрузки Excel',
            message: error.message
          });
        }
      };
      reader.readAsBinaryString(file);
    } else {
      reader.onload = (e) => {
        setLogData(e.target.result);
        handleAnalyzeData(e.target.result);
        
        NotificationSystem.notify({
          type: 'success',
          title: 'Файл загружен',
          message: `Файл ${file.name} успешно загружен`
        });
      };
      reader.readAsText(file);
    }
  }, [handleAnalyzeData]);

  // Функции управления интеграцией
  const handleConnectOPC = useCallback(async () => {
    const { url, username, password } = connectionSettings.opcua;
    const success = await EquipmentIntegration.connectOPC(url, username, password);
    
    setIntegrationStatus(prev => ({
      ...prev,
      opcua: {
        connected: success,
        url,
        status: success ? 'connected' : 'error'
      }
    }));
  }, [connectionSettings.opcua]);

  const handleConnectModbus = useCallback(async () => {
    const { host, port, unitId } = connectionSettings.modbus;
    const success = await EquipmentIntegration.connectModbus(host, port, unitId);
    
    setIntegrationStatus(prev => ({
      ...prev,
      modbus: {
        connected: success,
        host,
        port,
        status: success ? 'connected' : 'error'
      }
    }));
  }, [connectionSettings.modbus]);

  const handleConnectWebSocket = useCallback(() => {
    const { url } = connectionSettings.websocket;
    const success = EquipmentIntegration.connectWebSocket(url);
    
    setIntegrationStatus(prev => ({
      ...prev,
      websocket: {
        connected: success,
        url,
        status: success ? 'connected' : 'error'
      }
    }));
  }, [connectionSettings.websocket]);

  const handleDisconnectAll = useCallback(() => {
    EquipmentIntegration.disconnect();
    setIntegrationStatus({
      opcua: { connected: false, url: '', status: 'disconnected' },
      modbus: { connected: false, host: '', port: 502, status: 'disconnected' },
      websocket: { connected: false, url: '', status: 'disconnected' }
    });
    setRealTimeData([]);
    setEquipmentParameters({});
  }, []);

  // Чтение данных с оборудования
  const handleReadEquipmentData = useCallback(async () => {
    try {
      if (integrationStatus.opcua.connected) {
        const opcData = await EquipmentIntegration.readOPCNodes([
          'ns=2;s=Equipment1.Temperature',
          'ns=2;s=Equipment1.Pressure',
          'ns=2;s=Equipment1.Status',
          'ns=2;s=Equipment1.Speed'
        ]);
        
        console.log('OPC UA Data:', opcData);
      }
      
      if (integrationStatus.modbus.connected) {
        const modbusData = await EquipmentIntegration.readModbusRegisters([0, 1, 2, 3]);
        console.log('Modbus Data:', modbusData);
      }
      
      NotificationSystem.notify({
        type: 'info',
        title: 'Данные прочитаны',
        message: 'Данные с оборудования успешно получены'
      });
    } catch (error) {
      NotificationSystem.notify({
        type: 'error',
        title: 'Ошибка чтения',
        message: error.message
      });
    }
  }, [integrationStatus]);

  // Обработка загрузки файлов
  const handleFileUpload = useCallback((event) => {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    
    if (file.name.endsWith('.csv')) {
      reader.onload = (e) => {
        Papa.parse(e.target.result, {
          complete: (results) => {
            // Преобразование CSV в формат журнала
            const logEntries = results.data.map(row => {
              if (row.length >= 4) {
                return `[${row[0]}, ${row[1]}] ${row[2]}: ${row[3]}`;
              }
              return null;
            }).filter(Boolean).join('\n');
            
            setLogData(logEntries);
            handleAnalyzeData(logEntries);
            
            NotificationSystem.notify({
              type: 'success',
              title: 'CSV файл загружен',
              message: `Обработано ${results.data.length} записей`
            });
          },
          error: (error) => {
            NotificationSystem.notify({
              type: 'error',
              title: 'Ошибка загрузки CSV',
              message: error.message
            });
          }
        });
      };
      reader.readAsText(file);
    } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
      reader.onload = (e) => {
        try {
          const workbook = XLSX.read(e.target.result, { type: 'binary' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const data = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
          
          const logEntries = data.map(row => {
            if (row.length >= 4) {
              return `[${row[0]}, ${row[1]}] ${row[2]}: ${row[3]}`;
            }
            return null;
          }).filter(Boolean).join('\n');
          
          setLogData(logEntries);
          handleAnalyzeData(logEntries);
          
          NotificationSystem.notify({
            type: 'success',
            title: 'Excel файл загружен',
            message: `Обработано ${data.length} записей`
          });
        } catch (error) {
          NotificationSystem.notify({
            type: 'error',
            title: 'Ошибка загрузки Excel',
            message: error.message
          });
        }
      };
      reader.readAsBinaryString(file);
    } else {
      reader.onload = (e) => {
        setLogData(e.target.result);
        handleAnalyzeData(e.target.result);
        
        NotificationSystem.notify({
          type: 'success',
          title: 'Файл загружен',
          message: `Файл ${file.name} успешно загружен`
        });
      };
      reader.readAsText(file);
    }
  }, [handleAnalyzeData]);

  // Компоненты интерфейса

  // Модальное окно оборудования
  const EquipmentModal = ({ equipment, onClose }) => {
    const analysis = aiAnalysis[equipment?.code];
    const [activeSection, setActiveSection] = useState('overview');
    
    if (!equipment) return null;
    
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div className={`${isDarkMode ? 'bg-gray-800 text-white' : 'bg-white'} rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col`}>
          <div className={`p-6 border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-200'}`}>
            <div className="flex justify-between items-center">
              <h2 className="text-2xl font-bold flex items-center space-x-2">
                <Cpu className="text-blue-600" />
                <span>Паспорт оборудования: {equipment.code}</span>
              </h2>
              <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                <XCircle size={24} />
              </button>
            </div>
            
            {/* Навигация по разделам */}
            <div className="flex space-x-4 mt-4">
              {['overview', 'analytics', 'history', 'maintenance', 'documents'].map(section => (
                <button
                  key={section}
                  onClick={() => setActiveSection(section)}
                  className={`px-4 py-2 rounded-lg transition-colors ${
                    activeSection === section
                      ? 'bg-blue-600 text-white'
                      : isDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-100 hover:bg-gray-200'
                  }`}
                >
                  {section === 'overview' ? 'Обзор' :
                   section === 'analytics' ? 'Аналитика' :
                   section === 'history' ? 'История' :
                   section === 'maintenance' ? 'Обслуживание' : 'Документы'}
                </button>
              ))}
            </div>
          </div>
          
          <div className="flex-1 overflow-y-auto p-6">
            {/* Обзор */}
            {activeSection === 'overview' && (
              <div className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  {/* Основные показатели */}
                  <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                    <h3 className="text-lg font-semibold mb-4 flex items-center space-x-2">
                      <Gauge className="text-blue-500" />
                      <span>Ключевые показатели</span>
                    </h3>
                    <div className="space-y-3">
                      <div className="flex justify-between items-center">
                        <span className="text-sm text-gray-600">Готовность:</span>
                        <div className="flex items-center space-x-2">
                          <div className="w-24 bg-gray-200 rounded-full h-2">
                            <div className={`h-2 rounded-full ${
                              equipment.availability > 95 ? 'bg-green-500' :
                              equipment.availability > 85 ? 'bg-yellow-500' : 'bg-red-500'
                            }`} style={{width: `${equipment.availability}%`}}></div>
                          </div>
                          <span className="font-semibold">{equipment.availability}%</span>
                        </div>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-sm text-gray-600">Эффективность:</span>
                        <div className="flex items-center space-x-2">
                          <div className="w-24 bg-gray-200 rounded-full h-2">
                            <div className={`h-2 rounded-full ${
                              equipment.efficiency > 90 ? 'bg-green-500' :
                              equipment.efficiency > 75 ? 'bg-yellow-500' : 'bg-red-500'
                            }`} style={{width: `${equipment.efficiency}%`}}></div>
                          </div>
                          <span className="font-semibold">{equipment.efficiency}%</span>
                        </div>
                      </div>
                      <div className="flex justify-between items-center">
                        <span className="text-sm text-gray-600">Риск-оценка:</span>
                        <div className="flex items-center space-x-2">
                          <div className="w-24 bg-gray-200 rounded-full h-2">
                            <div className={`h-2 rounded-full ${
                              equipment.riskScore < 30 ? 'bg-green-500' :
                              equipment.riskScore < 70 ? 'bg-yellow-500' : 'bg-red-500'
                            }`} style={{width: `${equipment.riskScore}%`}}></div>
                          </div>
                          <span className="font-semibold">{equipment.riskScore}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  {/* Технические характеристики */}
                  <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                    <h3 className="text-lg font-semibold mb-4">Технические данные</h3>
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-600">Производитель:</span>
                        <span>{equipment.manufacturer}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Модель:</span>
                        <span>{equipment.model}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Серийный №:</span>
                        <span>{equipment.serialNumber}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Установлен:</span>
                        <span>{equipment.installationDate}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Местоположение:</span>
                        <span>{equipment.location}</span>
                      </div>
                    </div>
                  </div>
                  
                  {/* Эксплуатационные показатели */}
                  <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                    <h3 className="text-lg font-semibold mb-4">Эксплуатация</h3>
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-600">Наработка:</span>
                        <span>{equipment.operatingHours} ч</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">MTBF:</span>
                        <span>{equipment.mtbf} ч</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">MTTR:</span>
                        <span>{equipment.mttr} ч</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Энергопотребление:</span>
                        <span>{equipment.energyConsumption} кВт·ч</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Критичность:</span>
                        <span className={`px-2 py-1 rounded text-xs font-medium ${
                          equipment.criticality === 'high' ? 'bg-red-100 text-red-800' :
                          equipment.criticality === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                          'bg-green-100 text-green-800'
                        }`}>
                          {equipment.criticality === 'high' ? 'Критичное' :
                           equipment.criticality === 'medium' ? 'Важное' : 'Обычное'}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
                
                {/* Спецификации */}
                <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                  <h3 className="text-lg font-semibold mb-4">Технические спецификации</h3>
                  <div className="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm">
                    {Object.entries(equipment.specifications).map(([key, value]) => (
                      <div key={key}>
                        <span className="text-gray-600 capitalize">{key}:</span>
                        <p className="font-medium">{value}</p>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}
            
            {/* Аналитика */}
            {activeSection === 'analytics' && (
              <div className="space-y-6">
                {analysis ? (
                  <>
                    {/* AI Анализ */}
                    <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                      <h3 className="text-lg font-semibold mb-4 flex items-center space-x-2">
                        <Brain className="text-purple-500" />
                        <span>AI Анализ и прогнозы</span>
                      </h3>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                          <h4 className="font-medium mb-3">Рекомендации:</h4>
                          <div className="space-y-3">
                            {analysis.recommendations.map((rec, index) => (
                              <div key={index} className={`p-3 rounded-lg border-l-4 ${
                                rec.type === 'critical' ? 'border-red-500 bg-red-50' :
                                rec.type === 'warning' ? 'border-yellow-500 bg-yellow-50' :
                                'border-blue-500 bg-blue-50'
                              }`}>
                                <p className="font-medium text-sm">{rec.action}</p>
                                <div className="mt-2 grid grid-cols-2 gap-2 text-xs text-gray-600">
                                  <span>💰 {rec.cost?.toLocaleString()} ₽</span>
                                  <span>⏱️ {rec.timeline}</span>
                                  <span>📊 Точность: {(rec.confidence * 100).toFixed(0)}%</span>
                                  <span>📈 {rec.impact}</span>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                        
                        <div>
                          <h4 className="font-medium mb-3">Факторы риска:</h4>
                          <ul className="space-y-2 text-sm">
                            {analysis.riskFactors.map((factor, index) => (
                              <li key={index} className="flex items-start space-x-2">
                                <AlertTriangle size={16} className="text-yellow-500 mt-0.5" />
                                <span>{factor}</span>
                              </li>
                            ))}
                          </ul>
                          
                          {analysis.predictedFailure && (
                            <div className="mt-4 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                              <h5 className="font-medium text-orange-800">Прогноз отказа:</h5>
                              <p className="text-sm text-orange-700 mt-1">
                                {analysis.predictedFailure.date.toLocaleDateString()} 
                                (±{Math.round((analysis.predictedFailure.range.max - analysis.predictedFailure.range.min) / (24 * 60 * 60 * 1000))} дней)
                              </p>
                              <p className="text-xs text-orange-600 mt-1">
                                Точность: {(analysis.predictedFailure.confidence * 100).toFixed(0)}%
                              </p>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                    
                    {/* Оптимизация ТО */}
                    {analysis.maintenanceOptimization && (
                      <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                        <h3 className="text-lg font-semibold mb-4">Оптимизация обслуживания</h3>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                          <div className="text-center">
                            <p className="text-sm text-gray-600">Текущий интервал</p>
                            <p className="text-2xl font-bold">{analysis.maintenanceOptimization.currentInterval} дн</p>
                          </div>
                          <div className="text-center">
                            <p className="text-sm text-gray-600">Рекомендуемый</p>
                            <p className="text-2xl font-bold text-green-600">{analysis.maintenanceOptimization.recommendedInterval} дн</p>
                          </div>
                          <div className="text-center">
                            <p className="text-sm text-gray-600">Экономия</p>
                            <p className="text-2xl font-bold text-blue-600">{analysis.maintenanceOptimization.savings.toLocaleString()} ₽</p>
                          </div>
                          <div className="text-center">
                            <p className="text-sm text-gray-600">Точность</p>
                            <p className="text-2xl font-bold">{(analysis.maintenanceOptimization.confidence * 100).toFixed(0)}%</p>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {/* Анализ затрат */}
                    {analysis.costAnalysis && (
                      <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                        <h3 className="text-lg font-semibold mb-4">Анализ затрат</h3>
                        <div className="space-y-4">
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                            <div>
                              <p className="text-sm text-gray-600">Общие затраты</p>
                              <p className="text-xl font-bold">{analysis.costAnalysis.totalCost.toLocaleString()} ₽</p>
                            </div>
                            <div>
                              <p className="text-sm text-gray-600">Потери от простоев</p>
                              <p className="text-xl font-bold text-red-600">{analysis.costAnalysis.productionLoss.toLocaleString()} ₽</p>
                            </div>
                            <div>
                              <p className="text-sm text-gray-600">Затраты на ТО</p>
                              <p className="text-xl font-bold text-blue-600">{analysis.costAnalysis.maintenanceCosts.toLocaleString()} ₽</p>
                            </div>
                            <div>
                              <p className="text-sm text-gray-600">Затраты на ремонт</p>
                              <p className="text-xl font-bold text-orange-600">{analysis.costAnalysis.repairCosts.toLocaleString()} ₽</p>
                            </div>
                          </div>
                          <div className={`p-3 rounded-lg ${
                            analysis.costAnalysis.recommendation.includes('Увеличить') ? 'bg-yellow-50' : 'bg-green-50'
                          }`}>
                            <p className="font-medium">{analysis.costAnalysis.recommendation}</p>
                          </div>
                        </div>
                      </div>
                    )}
                  </>
                ) : (
                  <div className="text-center py-12">
                    <Brain size={48} className="mx-auto mb-4 text-gray-400" />
                    <p className="text-gray-500">AI анализ не выполнен</p>
                    <button 
                      onClick={() => handleAIAnalysis(equipment)}
                      disabled={isLoadingAI}
                      className="mt-4 px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50"
                    >
                      {isLoadingAI ? 'Анализ...' : 'Запустить AI анализ'}
                    </button>
                  </div>
                )}
              </div>
            )}
            
            {/* История событий */}
            {activeSection === 'history' && (
              <div className="space-y-4">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-semibold">История событий</h3>
                  <button 
                    onClick={() => handleExport('excel', equipment.defectHistory, `История_${equipment.code}`)}
                    className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"
                  >
                    Экспорт
                  </button>
                </div>
                
                {equipment.defectHistory?.length > 0 ? (
                  <div className="space-y-2 max-h-96 overflow-y-auto">
                    {equipment.defectHistory.slice().reverse().map((event, index) => (
                      <div key={index} className={`p-3 rounded-lg border ${
                        event.severity === 'high' ? 'border-red-200 bg-red-50' :
                        event.severity === 'medium' ? 'border-yellow-200 bg-yellow-50' :
                        'border-gray-200 bg-gray-50'
                      }`}>
                        <div className="flex items-start justify-between">
                          <div className="flex items-start space-x-3">
                            <div className={`w-3 h-3 rounded-full mt-1 ${
                              event.severity === 'high' ? 'bg-red-500' :
                              event.severity === 'medium' ? 'bg-yellow-500' : 'bg-green-500'
                            }`}></div>
                            <div>
                              <div className="flex items-center space-x-2">
                                <span className="font-medium">{event.date}</span>
                                <span className="px-2 py-1 bg-gray-200 rounded text-xs">{event.type}</span>
                              </div>
                              <p className="text-sm text-gray-600 mt-1">{event.description}</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="text-center text-gray-500">История событий отсутствует</p>
                )}
              </div>
            )}
            
            {/* График обслуживания */}
            {activeSection === 'maintenance' && (
              <div className="space-y-4">
                <h3 className="text-lg font-semibold mb-4">График технического обслуживания</h3>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                    <h4 className="font-medium mb-3">Предстоящие работы</h4>
                    <div className="space-y-2">
                      {maintenanceSchedule
                        .filter(m => m.equipment === equipment.code && m.status !== 'completed')
                        .slice(0, 5)
                        .map(maintenance => (
                          <div key={maintenance.id} className="flex items-center justify-between p-2 bg-white rounded">
                            <div>
                              <p className="font-medium text-sm">{maintenance.type}</p>
                              <p className="text-xs text-gray-600">{new Date(maintenance.date).toLocaleDateString()}</p>
                            </div>
                            <span className={`px-2 py-1 rounded text-xs ${
                              maintenance.priority === 'Высокий' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'
                            }`}>
                              {maintenance.priority}
                            </span>
                          </div>
                        ))}
                    </div>
                  </div>
                  
                  <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                    <h4 className="font-medium mb-3">Контракт на обслуживание</h4>
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-gray-600">Тип контракта:</span>
                        <span>{equipment.maintenanceContract}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Гарантия:</span>
                        <span className={equipment.warranty === 'Истекла' ? 'text-red-600' : 'text-green-600'}>
                          {equipment.warranty}
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Стоимость ТО:</span>
                        <span>{equipment.maintenanceCost.toLocaleString()} ₽</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Стоимость замены:</span>
                        <span>{equipment.replacementCost.toLocaleString()} ₽</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                {/* Запасные части */}
                <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                  <h4 className="font-medium mb-3">Запасные части</h4>
                  {equipment.spareParts && equipment.spareParts.length > 0 ? (
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">
                      {equipment.spareParts.map((part, index) => (
                        <div key={index} className="p-2 bg-white rounded">
                          <p className="font-medium">{part.name}</p>
                          <p className="text-xs text-gray-600">В наличии: {part.quantity}</p>
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-sm text-gray-500">Информация о запасных частях отсутствует</p>
                  )}
                </div>
              </div>
            )}
            
            {/* Документы */}
            {activeSection === 'documents' && (
              <div className="space-y-4">
                <h3 className="text-lg font-semibold mb-4">Документация</h3>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className={`p-4 rounded-lg border-2 border-dashed ${isDarkMode ? 'border-gray-600' : 'border-gray-300'} text-center cursor-pointer hover:bg-gray-50`}>
                    <FileText size={48} className="mx-auto mb-2 text-gray-400" />
                    <p className="font-medium">Загрузить документ</p>
                    <p className="text-sm text-gray-600">PDF, DOC, DOCX до 10MB</p>
                  </div>
                  
                  <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                    <div className="flex items-center justify-between mb-2">
                      <span className="font-medium">Паспорт оборудования.pdf</span>
                      <Download size={16} className="text-blue-600 cursor-pointer" />
                    </div>
                    <p className="text-xs text-gray-600">Загружен: 01.01.2025</p>
                  </div>
                </div>
              </div>
            )}
          </div>
          
          {/* Действия */}
          <div className={`p-6 border-t ${isDarkMode ? 'border-gray-700' : 'border-gray-200'}`}>
            <div className="flex justify-between">
              <div className="flex space-x-4">
                <button 
                  onClick={() => handleAIAnalysis(equipment)}
                  disabled={isLoadingAI}
                  className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50 flex items-center space-x-2"
                >
                  <Brain size={16} />
                  <span>{isLoadingAI ? 'Анализ...' : 'AI Анализ'}</span>
                </button>
                <button 
                  onClick={() => handleExport('pdf', equipment, `Паспорт_${equipment.code}`)}
                  className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center space-x-2"
                >
                  <Download size={16} />
                  <span>Экспорт PDF</span>
                </button>
                <button 
                  className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center space-x-2"
                >
                  <Edit size={16} />
                  <span>Редактировать</span>
                </button>
              </div>
              <button 
                onClick={onClose}
                className="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
              >
                Закрыть
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  // Карточка оборудования
  const EquipmentCard = ({ equipment }) => {
    const isSelected = selectedEquipmentForComparison.includes(equipment.code);
    
    return (
      <div 
        className={`relative ${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded-lg shadow-md border-l-4 ${
          equipment.criticality === 'high' ? 'border-red-500' :
          equipment.criticality === 'medium' ? 'border-yellow-500' : 'border-green-500'
        } cursor-pointer hover:shadow-lg transition-all ${
          isSelected ? 'ring-2 ring-blue-500' : ''
        }`}
        onClick={() => {
          if (comparisonMode) {
            if (isSelected) {
              setSelectedEquipmentForComparison(prev => prev.filter(e => e !== equipment.code));
            } else {
              setSelectedEquipmentForComparison(prev => [...prev, equipment.code]);
            }
          } else {
            setSelectedEquipment(equipment);
            setShowEquipmentModal(true);
          }
        }}
      >
        {comparisonMode && (
          <div className="absolute top-2 right-2">
            <input 
              type="checkbox" 
              checked={isSelected}
              onChange={() => {}}
              className="w-4 h-4"
              onClick={(e) => e.stopPropagation()}
            />
          </div>
        )}
        
        <div className="flex justify-between items-start mb-2">
          <h3 className="font-bold text-lg">{equipment.code}</h3>
          <div className="flex items-center space-x-2">
            <span className={`px-2 py-1 rounded text-xs font-medium ${
              equipment.criticality === 'high' ? 'bg-red-100 text-red-800' :
              equipment.criticality === 'medium' ? 'bg-yellow-100 text-yellow-800' :
              'bg-green-100 text-green-800'
            }`}>
              {equipment.criticality === 'high' ? 'Критичное' :
               equipment.criticality === 'medium' ? 'Важное' : 'Обычное'}
            </span>
          </div>
        </div>
        
        <div className="grid grid-cols-2 gap-2 text-sm">
          <div>
            <span className="text-gray-600">Готовность:</span>
            <p className={`font-medium ${
              equipment.availability > 95 ? 'text-green-600' :
              equipment.availability > 85 ? 'text-yellow-600' : 'text-red-600'
            }`}>{equipment.availability}%</p>
          </div>
          <div>
            <span className="text-gray-600">Эффективность:</span>
            <p className={`font-medium ${
              equipment.efficiency > 90 ? 'text-green-600' :
              equipment.efficiency > 75 ? 'text-yellow-600' : 'text-red-600'
            }`}>{equipment.efficiency}%</p>
          </div>
          <div>
            <span className="text-gray-600">MTBF:</span>
            <p className="font-medium">{equipment.mtbf}ч</p>
          </div>
          <div>
            <span className="text-gray-600">Риск:</span>
            <p className={`font-medium ${
              equipment.riskScore > 70 ? 'text-red-600' :
              equipment.riskScore > 40 ? 'text-yellow-600' : 'text-green-600'
            }`}>{equipment.riskScore}</p>
          </div>
        </div>
        
        <div className="mt-3 pt-3 border-t flex justify-between items-center">
          <span className="text-xs text-gray-500">{equipment.defectHistory?.length || 0} событий</span>
          <div className="flex space-x-1">
            {aiAnalysis[equipment.code] && (
              <div className="p-1 bg-purple-100 rounded" title="AI анализ выполнен">
                <Brain size={12} className="text-purple-600" />
              </div>
            )}
            <button 
              onClick={(e) => {
                e.stopPropagation();
                handleAIAnalysis(equipment);
              }}
              className="p-1 text-purple-600 hover:bg-purple-100 rounded"
              title="AI анализ"
            >
              <Brain size={14} />
            </button>
            <button 
              onClick={(e) => {
                e.stopPropagation();
                handleExport('pdf', equipment, `Паспорт_${equipment.code}`);
              }}
              className="p-1 text-blue-600 hover:bg-blue-100 rounded"
              title="Экспорт"
            >
              <Download size={14} />
            </button>
          </div>
        </div>
      </div>
    );
  };

  // Панель уведомлений
  const NotificationPanel = () => (
    <div className={`absolute right-0 top-12 w-96 ${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-xl border z-50 max-h-96 overflow-hidden`}>
      <div className={`p-4 border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-200'}`}>
        <div className="flex justify-between items-center">
          <h3 className="font-semibold">Уведомления</h3>
          <button 
            onClick={() => {
              setNotifications([]);
              NotificationSystem.notifications = [];
            }}
            className="text-sm text-blue-600 hover:text-blue-800"
          >
            Очистить все
          </button>
        </div>
      </div>
      <div className="divide-y max-h-80 overflow-y-auto">
        {notifications.slice(0, 10).map(notification => (
          <div key={notification.id} className={`p-4 hover:bg-gray-50 ${isDarkMode ? 'hover:bg-gray-700' : ''}`}>
            <div className="flex items-start space-x-3">
              <div className={`w-2 h-2 rounded-full mt-2 flex-shrink-0 ${
                notification.type === 'critical' ? 'bg-red-500' :
                notification.type === 'warning' ? 'bg-yellow-500' :
                notification.type === 'success' ? 'bg-green-500' : 'bg-blue-500'
              }`}></div>
              <div className="flex-1">
                <p className="font-medium text-sm">{notification.title}</p>
                <p className="text-xs text-gray-600 mt-1">{notification.message}</p>
                <p className="text-xs text-gray-400 mt-1">
                  {notification.timestamp.toLocaleTimeString()}
                </p>
              </div>
            </div>
          </div>
        ))}
        {notifications.length === 0 && (
          <div className="p-8 text-center text-gray-500">
            <Bell size={32} className="mx-auto mb-2 opacity-50" />
            <p>Нет новых уведомлений</p>
          </div>
        )}
      </div>
    </div>
  );

  // Компонент сравнения оборудования
  const EquipmentComparison = () => {
    const selectedEquipment = selectedEquipmentForComparison.map(code => equipmentRegistry[code]).filter(Boolean);
    
    if (selectedEquipment.length === 0) {
      return (
        <div className="text-center py-12 text-gray-500">
          <p>Выберите оборудование для сравнения</p>
        </div>
      );
    }
    
    return (
      <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
        <h3 className="text-lg font-bold mb-4">Сравнение оборудования</h3>
        
        <div className="overflow-x-auto">
          <table className="min-w-full">
            <thead>
              <tr className={`border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-200'}`}>
                <th className="text-left py-2">Параметр</th>
                {selectedEquipment.map(eq => (
                  <th key={eq.code} className="text-center py-2">{eq.code}</th>
                ))}
              </tr>
            </thead>
            <tbody className="divide-y">
              <tr>
                <td className="py-2">Готовность</td>
                {selectedEquipment.map(eq => (
                  <td key={eq.code} className={`text-center py-2 font-medium ${
                    eq.availability > 95 ? 'text-green-600' :
                    eq.availability > 85 ? 'text-yellow-600' : 'text-red-600'
                  }`}>
                    {eq.availability}%
                  </td>
                ))}
              </tr>
              <tr>
                <td className="py-2">Эффективность</td>
                {selectedEquipment.map(eq => (
                  <td key={eq.code} className={`text-center py-2 font-medium ${
                    eq.efficiency > 90 ? 'text-green-600' :
                    eq.efficiency > 75 ? 'text-yellow-600' : 'text-red-600'
                  }`}>
                    {eq.efficiency}%
                  </td>
                ))}
              </tr>
              <tr>
                <td className="py-2">MTBF</td>
                {selectedEquipment.map(eq => (
                  <td key={eq.code} className="text-center py-2">{eq.mtbf}ч</td>
                ))}
              </tr>
              <tr>
                <td className="py-2">MTTR</td>
                {selectedEquipment.map(eq => (
                  <td key={eq.code} className="text-center py-2">{eq.mttr}ч</td>
                ))}
              </tr>
              <tr>
                <td className="py-2">Риск-оценка</td>
                {selectedEquipment.map(eq => (
                  <td key={eq.code} className={`text-center py-2 font-medium ${
                    eq.riskScore > 70 ? 'text-red-600' :
                    eq.riskScore > 40 ? 'text-yellow-600' : 'text-green-600'
                  }`}>
                    {eq.riskScore}
                  </td>
                ))}
              </tr>
              <tr>
                <td className="py-2">Критичность</td>
                {selectedEquipment.map(eq => (
                  <td key={eq.code} className="text-center py-2">
                    <span className={`px-2 py-1 rounded text-xs ${
                      eq.criticality === 'high' ? 'bg-red-100 text-red-800' :
                      eq.criticality === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                      'bg-green-100 text-green-800'
                    }`}>
                      {eq.criticality === 'high' ? 'Высокая' :
                       eq.criticality === 'medium' ? 'Средняя' : 'Низкая'}
                    </span>
                  </td>
                ))}
              </tr>
              <tr>
                <td className="py-2">Стоимость ТО</td>
                {selectedEquipment.map(eq => (
                  <td key={eq.code} className="text-center py-2">{eq.maintenanceCost.toLocaleString()} ₽</td>
                ))}
              </tr>
            </tbody>
          </table>
        </div>
        
        <div className="mt-4 flex justify-end">
          <button 
            onClick={() => handleExport('excel', selectedEquipment, 'Сравнение_оборудования')}
            className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
          >
            Экспорт сравнения
          </button>
        </div>
      </div>
    );
  };

  return (
    <div className={`min-h-screen ${isDarkMode ? 'bg-gray-900 text-white' : 'bg-gray-100 text-gray-900'} transition-colors`}>
      {/* Заголовок */}
      <header className={`${isDarkMode ? 'bg-gray-800' : 'bg-gradient-to-r from-blue-600 to-blue-800'} text-white p-4 shadow-lg`}>
        <div className="container mx-auto">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-6">
              <h1 className="text-2xl font-bold">ЗаводАналитикс Pro</h1>
              <div className="flex items-center space-x-4 text-sm">
                <div className="flex items-center space-x-2">
                  <Globe size={16} />
                  <span>MCP Connected</span>
                  <div className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                </div>
                <div className="flex items-center space-x-2">
                  <Activity size={16} />
                  <span>{parsedData.length} событий</span>
                </div>
                {realTimeMode && (
                  <div className="flex items-center space-x-2">
                    <Zap size={16} className="text-yellow-400" />
                    <span>Режим реального времени</span>
                  </div>
                )}
              </div>
            </div>
            
            <div className="flex items-center space-x-4">
              {/* Уведомления */}
              <div className="relative">
                <button 
                  onClick={() => setShowNotifications(!showNotifications)}
                  className="relative p-2 rounded-full hover:bg-blue-700 transition-colors"
                >
                  {notifications.filter(n => !n.read).length > 0 ? <BellRing size={20} /> : <Bell size={20} />}
                  {notifications.filter(n => !n.read).length > 0 && (
                    <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center">
                      {notifications.filter(n => !n.read).length}
                    </span>
                  )}
                </button>
                {showNotifications && <NotificationPanel />}
              </div>
              
              {/* Темная тема */}
              <button 
                onClick={() => setIsDarkMode(!isDarkMode)}
                className="p-2 rounded-full hover:bg-blue-700 transition-colors"
                title="Переключить тему"
              >
                {isDarkMode ? <Eye size={20} /> : <EyeOff size={20} />}
              </button>
              
              {/* Полноэкранный режим */}
              <button 
                onClick={() => {
                  if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    setIsFullscreen(true);
                  } else {
                    document.exitFullscreen();
                    setIsFullscreen(false);
                  }
                }}
                className="p-2 rounded-full hover:bg-blue-700 transition-colors"
                title="Полноэкранный режим"
              >
                {isFullscreen ? <Minimize2 size={20} /> : <Maximize2 size={20} />}
              </button>
            </div>
          </div>
          
          {/* Навигация */}
          <div className="flex space-x-2 mt-4">
            {['dashboard', 'equipment', 'integration', 'maintenance', 'log', 'analytics', 'settings'].map(tab => (
              <button 
                key={tab}
                className={`px-4 py-2 rounded transition-colors ${
                  activeTab === tab 
                    ? isDarkMode ? 'bg-gray-700' : 'bg-blue-900' 
                    : isDarkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-blue-700 hover:bg-blue-800'
                }`}
                onClick={() => setActiveTab(tab)}
              >
                {tab === 'dashboard' ? 'Дашборд' :
                 tab === 'equipment' ? 'Оборудование' :
                 tab === 'integration' ? 'Интеграция' :
                 tab === 'maintenance' ? 'ТО и ремонт' :
                 tab === 'log' ? 'Журнал' :
                 tab === 'analytics' ? 'Аналитика' : 'Настройки'}
              </button>
            ))}
          </div>
        </div>
      </header>

      <main className="container mx-auto p-4">
        {/* Дашборд */}
        {activeTab === 'dashboard' && (
          <div className="space-y-6">
            {/* KPI панель */}
            <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded-lg shadow-md`}>
                <div className="flex items-center justify-between mb-2">
                  <h3 className="font-semibold">Всего событий</h3>
                  <Database className="text-blue-600" size={20} />
                </div>
                <p className="text-3xl font-bold text-blue-700">{parsedData.length}</p>
                <p className="text-xs text-gray-500 mt-1">За текущий период</p>
              </div>
              
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded-lg shadow-md`}>
                <div className="flex items-center justify-between mb-2">
                  <h3 className="font-semibold">Критических</h3>
                  <AlertTriangle className="text-red-600" size={20} />
                </div>
                <p className="text-3xl font-bold text-red-700">
                  {parsedData.filter(item => item.severity === 'high').length}
                </p>
                <p className="text-xs text-gray-500 mt-1">Требуют внимания</p>
              </div>
              
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded-lg shadow-md`}>
                <div className="flex items-center justify-between mb-2">
                  <h3 className="font-semibold">Оборудования</h3>
                  <Wrench className="text-green-600" size={20} />
                </div>
                <p className="text-3xl font-bold text-green-700">
                  {Object.keys(equipmentRegistry).length}
                </p>
                <p className="text-xs text-gray-500 mt-1">Единиц в реестре</p>
              </div>
              
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded-lg shadow-md`}>
                <div className="flex items-center justify-between mb-2">
                  <h3 className="font-semibold">Готовность</h3>
                  <Activity className="text-purple-600" size={20} />
                </div>
                <p className="text-3xl font-bold text-purple-700">
                  {Object.values(equipmentRegistry).length > 0 ? 
                    Math.round(Object.values(equipmentRegistry).reduce((acc, eq) => acc + eq.availability, 0) / Object.values(equipmentRegistry).length) : 0}%
                </p>
                <p className="text-xs text-gray-500 mt-1">Средняя готовность</p>
              </div>
              
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded-lg shadow-md`}>
                <div className="flex items-center justify-between mb-2">
                  <h3 className="font-semibold">Простой оборудования</h3>
                  <Clock className="text-orange-600" size={20} />
                </div>
                <p className="text-3xl font-bold text-orange-700">
                  {Math.round(downtimeStats.today.total / 60 * 10) / 10}ч
                </p>
                <p className="text-xs text-gray-500 mt-1">За сегодня</p>
                <div className="mt-2 text-xs">
                  <div className="flex justify-between text-gray-600">
                    <span>Неделя:</span>
                    <span className="font-medium">{Math.round(downtimeStats.week.total / 60 * 10) / 10}ч</span>
                  </div>
                  <div className="flex justify-between text-gray-600">
                    <span>Месяц:</span>
                    <span className="font-medium">{Math.round(downtimeStats.month.total / 60 * 10) / 10}ч</span>
                  </div>
                </div>
              </div>
            </div>

            {/* Основные графики */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* График событий по критичности */}
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold">Критичность событий</h2>
                  <button 
                    onClick={() => handleExport('excel', severityStats, 'Критичность_событий')}
                    className="p-2 text-blue-600 hover:bg-blue-100 rounded"
                    title="Экспорт данных"
                  >
                    <Download size={16} />
                  </button>
                </div>
                <div className="h-64">
                  {severityStats.length > 0 ? (
                    <ResponsiveContainer width="100%" height="100%">
                      <PieChart>
                        <Pie
                          data={severityStats}
                          cx="50%"
                          cy="50%"
                          outerRadius={80}
                          dataKey="value"
                          nameKey="name"
                          label={({name, percent}) => `${name} ${(percent * 100).toFixed(0)}%`}
                        >
                          {severityStats.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={entry.fill} />
                          ))}
                        </Pie>
                        <Tooltip />
                      </PieChart>
                    </ResponsiveContainer>
                  ) : (
                    <div className="h-full flex items-center justify-center text-gray-500">
                      Нет данных для отображения
                    </div>
                  )}
                </div>
              </div>

              {/* График по оборудованию */}
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold">Топ оборудования по событиям</h2>
                  <div className="flex space-x-2">
                    <button 
                      onClick={() => handleExport('excel', equipmentStats, 'Активность_оборудования')}
                      className="p-2 text-blue-600 hover:bg-blue-100 rounded"
                      title="Экспорт данных"
                    >
                      <Download size={16} />
                    </button>
                  </div>
                </div>
                <div className="h-64">
                  {equipmentStats.length > 0 ? (
                    <ResponsiveContainer width="100%" height="100%">
                      <BarChart data={equipmentStats.slice(0, 8)} layout="vertical">
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis type="number" />
                        <YAxis dataKey="name" type="category" width={60} />
                        <Tooltip 
                          content={({active, payload}) => {
                            if (active && payload && payload.length) {
                              const data = payload[0].payload;
                              const equipment = equipmentRegistry[data.name];
                              return (
                                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-3 border rounded shadow-lg`}>
                                  <p className="font-semibold">{data.name}</p>
                                  <p>События: {data.value}</p>
                                  {equipment && (
                                    <>
                                      <p>Готовность: {equipment.availability}%</p>
                                      <p>Риск: {equipment.riskScore}</p>
                                    </>
                                  )}
                                </div>
                              );
                            }
                            return null;
                          }}
                        />
                        <Bar 
                          dataKey="value" 
                          fill="#8884d8"
                          onClick={(data) => {
                            const equipment = equipmentRegistry[data.name];
                            if (equipment) {
                              setSelectedEquipment(equipment);
                              setShowEquipmentModal(true);
                            }
                          }}
                          style={{cursor: 'pointer'}}
                        />
                      </BarChart>
                    </ResponsiveContainer>
                  ) : (
                    <div className="h-full flex items-center justify-center text-gray-500">
                      Нет данных для отображения
                    </div>
                  )}
                </div>
              </div>

              {/* Временная динамика */}
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md lg:col-span-2`}>
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-bold">Динамика событий по дням</h2>
                  <div className="flex space-x-2">
                    <button 
                      onClick={() => setRealTimeMode(!realTimeMode)}
                      className={`px-3 py-1 rounded flex items-center space-x-2 ${
                        realTimeMode ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700'
                      }`}
                    >
                      <Zap size={14} />
                      <span className="text-sm">Real-time</span>
                    </button>
                    <button 
                      onClick={() => handleExport('excel', timelineData, 'Динамика_событий')}
                      className="p-2 text-blue-600 hover:bg-blue-100 rounded"
                      title="Экспорт данных"
                    >
                      <Download size={16} />
                    </button>
                  </div>
                </div>
                <div className="h-64">
                  {timelineData.length > 0 ? (
                    <ResponsiveContainer width="100%" height="100%">
                      <AreaChart data={timelineData}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="date" />
                        <YAxis />
                        <Tooltip />
                        <Legend />
                        <Area type="monotone" dataKey="Критический" stackId="1" stroke="#dc2626" fill="#dc2626" fillOpacity={0.6} />
                        <Area type="monotone" dataKey="Высокий" stackId="1" stroke="#f59e0b" fill="#f59e0b" fillOpacity={0.6} />
                        <Area type="monotone" dataKey="Низкий" stackId="1" stroke="#059669" fill="#059669" fillOpacity={0.6} />
                        <Area type="monotone" dataKey="Информация" stackId="1" stroke="#3b82f6" fill="#3b82f6" fillOpacity={0.6} />
                      </AreaChart>
                    </ResponsiveContainer>
                  ) : (
                    <div className="h-full flex items-center justify-center text-gray-500">
                      Нет данных для отображения
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Панель времени простоя */}
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md border-l-4 ${
              downtimeStats.today.total > 480 ? 'border-red-500' : 
              downtimeStats.today.total > 240 ? 'border-orange-500' : 'border-green-500'
            }`}>
              <div className="flex items-center space-x-2 mb-4">
                <Clock className={`${
                  downtimeStats.today.total > 480 ? 'text-red-600' : 
                  downtimeStats.today.total > 240 ? 'text-orange-600' : 'text-green-600'
                } `} size={24} />
                <h2 className="text-xl font-bold">Анализ времени простоя</h2>
                <span className={`px-2 py-1 rounded text-sm font-medium ${
                  downtimeStats.today.total > 480 ? 'bg-red-100 text-red-800' : 
                  downtimeStats.today.total > 240 ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800'
                }`}>
                  {downtimeStats.today.total > 480 ? 'Критический уровень' : 
                   downtimeStats.today.total > 240 ? 'Повышенный уровень' : 'Нормальный уровень'}
                </span>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {/* Сегодня */}
                <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                  <h3 className="font-semibold mb-3 flex items-center space-x-2">
                    <Calendar size={16} />
                    <span>Сегодня</span>
                  </h3>
                  <div className="space-y-3">
                    <div className="text-center">
                      <p className="text-3xl font-bold text-orange-600">
                        {Math.round(downtimeStats.today.total / 60 * 10) / 10}
                      </p>
                      <p className="text-sm text-gray-600">часов простоя</p>
                    </div>
                    
                    <div className="space-y-2">
                      <div className="flex justify-between text-sm">
                        <span>Потери:</span>
                        <span className="font-medium text-red-600">
                          {Math.round(downtimeStats.today.total * 833).toLocaleString()} ₽
                        </span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span>События:</span>
                        <span className="font-medium">
                          {downtimeStats.details.filter(d => {
                            const today = new Date().toLocaleDateString('ru-RU').split('.').reverse().join('.');
                            return d.date === today.slice(2);
                          }).length}
                        </span>
                      </div>
                    </div>
                    
                    {Object.keys(downtimeStats.today.equipment).length > 0 && (
                      <div>
                        <h4 className="font-medium text-sm mb-2">По оборудованию:</h4>
                        <div className="space-y-1 max-h-32 overflow-y-auto">
                          {Object.entries(downtimeStats.today.equipment)
                            .sort(([,a], [,b]) => b - a)
                            .slice(0, 5)
                            .map(([equipment, minutes]) => (
                            <div key={equipment} className="flex justify-between text-xs">
                              <span className="truncate">{equipment}</span>
                              <span className="font-medium">
                                {Math.round(minutes / 60 * 10) / 10}ч
                              </span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* Неделя */}
                <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                  <h3 className="font-semibold mb-3 flex items-center space-x-2">
                    <Activity size={16} />
                    <span>Неделя</span>
                  </h3>
                  <div className="space-y-3">
                    <div className="text-center">
                      <p className="text-3xl font-bold text-blue-600">
                        {Math.round(downtimeStats.week.total / 60 * 10) / 10}
                      </p>
                      <p className="text-sm text-gray-600">часов простоя</p>
                    </div>
                    
                    <div className="space-y-2">
                      <div className="flex justify-between text-sm">
                        <span>Потери:</span>
                        <span className="font-medium text-red-600">
                          {Math.round(downtimeStats.week.total * 833).toLocaleString()} ₽
                        </span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span>Среднее/день:</span>
                        <span className="font-medium">
                          {Math.round(downtimeStats.week.total / 60 / 7 * 10) / 10}ч
                        </span>
                      </div>
                    </div>
                    
                    {Object.keys(downtimeStats.week.equipment).length > 0 && (
                      <div>
                        <h4 className="font-medium text-sm mb-2">Топ оборудования:</h4>
                        <div className="space-y-1 max-h-32 overflow-y-auto">
                          {Object.entries(downtimeStats.week.equipment)
                            .sort(([,a], [,b]) => b - a)
                            .slice(0, 5)
                            .map(([equipment, minutes]) => (
                            <div key={equipment} className="flex justify-between text-xs">
                              <span className="truncate">{equipment}</span>
                              <span className="font-medium">
                                {Math.round(minutes / 60 * 10) / 10}ч
                              </span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* Месяц */}
                <div className={`p-4 rounded-lg ${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                  <h3 className="font-semibold mb-3 flex items-center space-x-2">
                    <TrendingUp size={16} />
                    <span>Месяц</span>
                  </h3>
                  <div className="space-y-3">
                    <div className="text-center">
                      <p className="text-3xl font-bold text-purple-600">
                        {Math.round(downtimeStats.month.total / 60 * 10) / 10}
                      </p>
                      <p className="text-sm text-gray-600">часов простоя</p>
                    </div>
                    
                    <div className="space-y-2">
                      <div className="flex justify-between text-sm">
                        <span>Потери:</span>
                        <span className="font-medium text-red-600">
                          {Math.round(downtimeStats.month.total * 833).toLocaleString()} ₽
                        </span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span>Среднее/день:</span>
                        <span className="font-medium">
                          {Math.round(downtimeStats.month.total / 60 / new Date().getDate() * 10) / 10}ч
                        </span>
                      </div>
                      <div className="flex justify-between text-sm">
                        <span>Коэффициент:</span>
                        <span className={`font-medium ${
                          (downtimeStats.month.total / 60 / new Date().getDate()) < 4 ? 'text-green-600' :
                          (downtimeStats.month.total / 60 / new Date().getDate()) < 8 ? 'text-yellow-600' : 'text-red-600'
                        }`}>
                          {((1 - (downtimeStats.month.total / 60 / new Date().getDate() / 24)) * 100).toFixed(1)}%
                        </span>
                      </div>
                    </div>
                    
                    {Object.keys(downtimeStats.month.equipment).length > 0 && (
                      <div>
                        <h4 className="font-medium text-sm mb-2">Проблемное оборудование:</h4>
                        <div className="space-y-1 max-h-32 overflow-y-auto">
                          {Object.entries(downtimeStats.month.equipment)
                            .sort(([,a], [,b]) => b - a)
                            .slice(0, 5)
                            .map(([equipment, minutes]) => (
                            <div key={equipment} className="flex justify-between text-xs">
                              <span className="truncate">{equipment}</span>
                              <span className="font-medium">
                                {Math.round(minutes / 60 * 10) / 10}ч
                              </span>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
              
              {/* Детализация простоев */}
              {downtimeStats.details.length > 0 && (
                <div className="mt-6">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="font-semibold">Последние события простоя</h3>
                    <button 
                      onClick={() => handleExport('excel', downtimeStats.details, 'События_простоя')}
                      className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"
                    >
                      Экспорт
                    </button>
                  </div>
                  
                  <div className="overflow-x-auto">
                    <table className="min-w-full text-sm">
                      <thead className={`${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                        <tr>
                          <th className="px-3 py-2 text-left">Дата</th>
                          <th className="px-3 py-2 text-left">Время</th>
                          <th className="px-3 py-2 text-left">Оборудование</th>
                          <th className="px-3 py-2 text-left">Простой</th>
                          <th className="px-3 py-2 text-left">Потери</th>
                          <th className="px-3 py-2 text-left">Причина</th>
                        </tr>
                      </thead>
                      <tbody className={`divide-y ${isDarkMode ? 'divide-gray-700' : 'divide-gray-200'}`}>
                        {downtimeStats.details.slice(0, 10).map((detail, index) => (
                          <tr key={index} className={`hover:bg-gray-50 ${isDarkMode ? 'hover:bg-gray-700' : ''}`}>
                            <td className="px-3 py-2">{detail.date}</td>
                            <td className="px-3 py-2">{detail.time}</td>
                            <td className="px-3 py-2 font-medium">{detail.equipment}</td>
                            <td className="px-3 py-2">
                              <span className="font-medium text-orange-600">
                                {detail.downtimeHours}ч
                              </span>
                            </td>
                            <td className="px-3 py-2">
                              <span className="font-medium text-red-600">
                                {detail.estimatedCost.toLocaleString()} ₽
                              </span>
                            </td>
                            <td className="px-3 py-2 max-w-xs truncate" title={detail.message}>
                              {detail.message}
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold">Интеллектуальные рекомендации</h2>
                <div className="flex space-x-2">
                  <button 
                    className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center space-x-2 disabled:opacity-50"
                    disabled={isLoadingAI}
                    onClick={async () => {
                      setIsLoadingAI(true);
                      // Массовый AI анализ
                      for (const equipment of Object.values(equipmentRegistry).slice(0, 5)) {
                        await handleAIAnalysis(equipment);
                      }
                      setIsLoadingAI(false);
                      
                      NotificationSystem.notify({
                        type: 'success',
                        title: 'AI анализ завершен',
                        message: 'Проанализировано критическое оборудование'
                      });
                    }}
                  >
                    <Brain size={16} />
                    <span>{isLoadingAI ? 'Анализ...' : 'AI-анализ всех'}</span>
                  </button>
                  <button 
                    onClick={() => handleExport('pdf', recommendations, 'Рекомендации')}
                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center space-x-2"
                  >
                    <FileText size={16} />
                    <span>Отчет PDF</span>
                  </button>
                </div>
              </div>
              
              <div className="space-y-4">
                {recommendations.length > 0 ? (
                  recommendations.slice(0, 5).map((rec, index) => (
                    <div 
                      key={index} 
                      className={`p-4 rounded-lg border-l-4 ${
                        rec.priority === 'Критический' ? 'bg-red-50 border-red-500' : 
                        rec.priority === 'Высокий' ? 'bg-orange-50 border-orange-500' : 
                        rec.priority === 'Средний' ? 'bg-yellow-50 border-yellow-500' :
                        'bg-green-50 border-green-500'
                      }`}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex items-start space-x-3 flex-1">
                          <div className={`p-2 rounded-full ${
                            rec.priority === 'Критический' ? 'bg-red-100 text-red-700' : 
                            rec.priority === 'Высокий' ? 'bg-orange-100 text-orange-700' : 
                            rec.priority === 'Средний' ? 'bg-yellow-100 text-yellow-700' :
                            'bg-green-100 text-green-700'
                          }`}>
                            <AlertTriangle size={18} />
                          </div>
                          <div className="flex-1">
                            <div className="flex items-center space-x-2 mb-1">
                              <h3 className="font-bold">{rec.priority}</h3>
                              {rec.equipment && (
                                <span className="text-sm bg-gray-200 px-2 py-1 rounded cursor-pointer hover:bg-gray-300"
                                      onClick={() => {
                                        const equipment = equipmentRegistry[rec.equipment];
                                        if (equipment) {
                                          setSelectedEquipment(equipment);
                                          setShowEquipmentModal(true);
                                        }
                                      }}>
                                  {rec.equipment}
                                </span>
                              )}
                              {rec.confidence && (
                                <span className="text-sm text-gray-600">
                                  Точность: {(rec.confidence * 100).toFixed(0)}%
                                </span>
                              )}
                              {rec.source && (
                                <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                  {rec.source}
                                </span>
                              )}
                            </div>
                            <p className="text-gray-800 mb-2">{rec.text}</p>
                            
                            <div className="flex items-center space-x-4 text-sm">
                              {rec.estimatedCost > 0 && (
                                <span className="text-gray-600">
                                  💰 {rec.estimatedCost.toLocaleString()} ₽
                                </span>
                              )}
                              {rec.impact && (
                                <span className="text-gray-600">
                                  📈 {rec.impact}
                                </span>
                              )}
                              {rec.timeline && (
                                <span className="text-gray-600">
                                  ⏱️ {rec.timeline}
                                </span>
                              )}
                              {rec.aiPrediction && (
                                <span className="text-orange-600">
                                  ⚠️ Прогноз отказа: {new Date(rec.aiPrediction.date).toLocaleDateString()}
                                </span>
                              )}
                            </div>
                          </div>
                        </div>
                        
                        <div className="flex space-x-2">
                          {rec.actionRequired && (
                            <button className="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                              Создать заявку
                            </button>
                          )}
                        </div>
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="text-center py-8 text-gray-500">
                    <Brain size={48} className="mx-auto mb-4 opacity-50" />
                    <p>Нет активных рекомендаций</p>
                    <p className="text-sm">Загрузите данные журнала для анализа</p>
                  </div>
                )}
              </div>
              
              {recommendations.length > 5 && (
                <div className="mt-4 text-center">
                  <button 
                    onClick={() => setActiveTab('analytics')}
                    className="text-blue-600 hover:text-blue-800"
                  >
                    Показать все рекомендации ({recommendations.length})
                  </button>
                </div>
              )}
            </div>

            {/* Критическое оборудование */}
            {criticalEquipment.length > 0 && (
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md border-l-4 border-red-500`}>
                <div className="flex items-center space-x-2 mb-4">
                  <AlertTriangle className="text-red-600" size={24} />
                  <h2 className="text-xl font-bold text-red-600">Критическое оборудование</h2>
                  <span className="bg-red-100 text-red-800 px-2 py-1 rounded text-sm">
                    {criticalEquipment.length} единиц
                  </span>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {criticalEquipment.slice(0, 6).map(equipment => (
                    <div key={equipment.id} className="border border-red-200 rounded-lg p-3 bg-red-50">
                      <div className="flex justify-between items-center mb-2">
                        <h4 className="font-semibold text-red-800">{equipment.code}</h4>
                        <span className="text-xs bg-red-200 text-red-800 px-2 py-1 rounded">
                          Риск: {equipment.riskScore}
                        </span>
                      </div>
                      <div className="space-y-1 text-sm">
                        <div className="flex justify-between">
                          <span>Готовность:</span>
                          <span className="font-medium">{equipment.availability}%</span>
                        </div>
                        <div className="flex justify-between">
                          <span>События:</span>
                          <span className="font-medium">{equipment.defectHistory?.length || 0}</span>
                        </div>
                        <div className="flex justify-between">
                          <span>MTBF:</span>
                          <span className="font-medium">{equipment.mtbf}ч</span>
                        </div>
                      </div>
                      <button 
                        onClick={() => {
                          setSelectedEquipment(equipment);
                          setShowEquipmentModal(true);
                        }}
                        className="w-full mt-3 px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700"
                      >
                        Подробнее
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}

        {/* Вкладка Интеграция с оборудованием */}
        {activeTab === 'integration' && (
          <div className="space-y-6">
            {/* Статус подключений */}
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold">Интеграция с промышленным оборудованием</h2>
                <div className="flex space-x-2">
                  <button 
                    onClick={handleReadEquipmentData}
                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center space-x-2"
                    disabled={!integrationStatus.opcua.connected && !integrationStatus.modbus.connected}
                  >
                    <RefreshCw size={16} />
                    <span>Читать данные</span>
                  </button>
                  <button 
                    onClick={handleDisconnectAll}
                    className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 flex items-center space-x-2"
                  >
                    <XCircle size={16} />
                    <span>Отключить все</span>
                  </button>
                </div>
              </div>
              
              {/* Карточки статуса */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {/* OPC UA */}
                <div className={`p-4 rounded-lg border-l-4 ${
                  integrationStatus.opcua.connected ? 'border-green-500 bg-green-50' : 'border-gray-400 bg-gray-50'
                }`}>
                  <div className="flex items-center space-x-2 mb-2">
                    <Cpu className={integrationStatus.opcua.connected ? 'text-green-600' : 'text-gray-400'} size={20} />
                    <h3 className="font-semibold">OPC UA</h3>
                    <div className={`w-3 h-3 rounded-full ${
                      integrationStatus.opcua.connected ? 'bg-green-500 animate-pulse' : 'bg-gray-400'
                    }`}></div>
                  </div>
                  <p className="text-sm text-gray-600 mb-2">
                    {integrationStatus.opcua.connected ? 'Подключено' : 'Отключено'}
                  </p>
                  {integrationStatus.opcua.url && (
                    <p className="text-xs text-gray-500">{integrationStatus.opcua.url}</p>
                  )}
                </div>
                
                {/* Modbus */}
                <div className={`p-4 rounded-lg border-l-4 ${
                  integrationStatus.modbus.connected ? 'border-green-500 bg-green-50' : 'border-gray-400 bg-gray-50'
                }`}>
                  <div className="flex items-center space-x-2 mb-2">
                    <Settings className={integrationStatus.modbus.connected ? 'text-green-600' : 'text-gray-400'} size={20} />
                    <h3 className="font-semibold">Modbus TCP</h3>
                    <div className={`w-3 h-3 rounded-full ${
                      integrationStatus.modbus.connected ? 'bg-green-500 animate-pulse' : 'bg-gray-400'
                    }`}></div>
                  </div>
                  <p className="text-sm text-gray-600 mb-2">
                    {integrationStatus.modbus.connected ? 'Подключено' : 'Отключено'}
                  </p>
                  {integrationStatus.modbus.host && (
                    <p className="text-xs text-gray-500">{integrationStatus.modbus.host}:{integrationStatus.modbus.port}</p>
                  )}
                </div>
                
                {/* WebSocket */}
                <div className={`p-4 rounded-lg border-l-4 ${
                  integrationStatus.websocket.connected ? 'border-green-500 bg-green-50' : 'border-gray-400 bg-gray-50'
                }`}>
                  <div className="flex items-center space-x-2 mb-2">
                    <Globe className={integrationStatus.websocket.connected ? 'text-green-600' : 'text-gray-400'} size={20} />
                    <h3 className="font-semibold">WebSocket</h3>
                    <div className={`w-3 h-3 rounded-full ${
                      integrationStatus.websocket.connected ? 'bg-green-500 animate-pulse' : 'bg-gray-400'
                    }`}></div>
                  </div>
                  <p className="text-sm text-gray-600 mb-2">
                    {integrationStatus.websocket.connected ? 'Real-time активен' : 'Отключено'}
                  </p>
                  {integrationStatus.websocket.url && (
                    <p className="text-xs text-gray-500">{integrationStatus.websocket.url}</p>
                  )}
                </div>
              </div>
            </div>

            {/* Настройки подключений */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
              {/* OPC UA настройки */}
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
                <h3 className="text-lg font-bold mb-4 flex items-center space-x-2">
                  <Cpu className="text-blue-500" />
                  <span>OPC UA Server</span>
                </h3>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">URL сервера</label>
                    <input 
                      type="text" 
                      className={`w-full p-2 border rounded ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}
                      value={connectionSettings.opcua.url}
                      onChange={(e) => setConnectionSettings(prev => ({
                        ...prev,
                        opcua: { ...prev.opcua, url: e.target.value }
                      }))}
                      placeholder="opc.tcp://localhost:4840"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Пользователь</label>
                    <input 
                      type="text" 
                      className={`w-full p-2 border rounded ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}
                      value={connectionSettings.opcua.username}
                      onChange={(e) => setConnectionSettings(prev => ({
                        ...prev,
                        opcua: { ...prev.opcua, username: e.target.value }
                      }))}
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Пароль</label>
                    <input 
                      type="password" 
                      className={`w-full p-2 border rounded ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}
                      value={connectionSettings.opcua.password}
                      onChange={(e) => setConnectionSettings(prev => ({
                        ...prev,
                        opcua: { ...prev.opcua, password: e.target.value }
                      }))}
                    />
                  </div>
                  <button 
                    onClick={handleConnectOPC}
                    className={`w-full py-2 rounded font-medium ${
                      integrationStatus.opcua.connected 
                        ? 'bg-green-600 text-white' 
                        : 'bg-blue-600 text-white hover:bg-blue-700'
                    }`}
                    disabled={integrationStatus.opcua.connected}
                  >
                    {integrationStatus.opcua.connected ? 'Подключено' : 'Подключиться'}
                  </button>
                </div>
              </div>

              {/* Modbus настройки */}
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
                <h3 className="text-lg font-bold mb-4 flex items-center space-x-2">
                  <Settings className="text-orange-500" />
                  <span>Modbus TCP</span>
                </h3>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">IP адрес</label>
                    <input 
                      type="text" 
                      className={`w-full p-2 border rounded ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}
                      value={connectionSettings.modbus.host}
                      onChange={(e) => setConnectionSettings(prev => ({
                        ...prev,
                        modbus: { ...prev.modbus, host: e.target.value }
                      }))}
                      placeholder="192.168.1.100"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Порт</label>
                    <input 
                      type="number" 
                      className={`w-full p-2 border rounded ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}
                      value={connectionSettings.modbus.port}
                      onChange={(e) => setConnectionSettings(prev => ({
                        ...prev,
                        modbus: { ...prev.modbus, port: parseInt(e.target.value) }
                      }))}
                      placeholder="502"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Unit ID</label>
                    <input 
                      type="number" 
                      className={`w-full p-2 border rounded ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}
                      value={connectionSettings.modbus.unitId}
                      onChange={(e) => setConnectionSettings(prev => ({
                        ...prev,
                        modbus: { ...prev.modbus, unitId: parseInt(e.target.value) }
                      }))}
                      placeholder="1"
                    />
                  </div>
                  <button 
                    onClick={handleConnectModbus}
                    className={`w-full py-2 rounded font-medium ${
                      integrationStatus.modbus.connected 
                        ? 'bg-green-600 text-white' 
                        : 'bg-orange-600 text-white hover:bg-orange-700'
                    }`}
                    disabled={integrationStatus.modbus.connected}
                  >
                    {integrationStatus.modbus.connected ? 'Подключено' : 'Подключиться'}
                  </button>
                </div>
              </div>

              {/* WebSocket настройки */}
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
                <h3 className="text-lg font-bold mb-4 flex items-center space-x-2">
                  <Globe className="text-green-500" />
                  <span>WebSocket</span>
                </h3>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">WebSocket URL</label>
                    <input 
                      type="text" 
                      className={`w-full p-2 border rounded ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}
                      value={connectionSettings.websocket.url}
                      onChange={(e) => setConnectionSettings(prev => ({
                        ...prev,
                        websocket: { ...prev.websocket, url: e.target.value }
                      }))}
                      placeholder="ws://localhost:8080/equipment"
                    />
                  </div>
                  <div className="text-sm text-gray-600">
                    <p>WebSocket обеспечивает:</p>
                    <ul className="list-disc list-inside mt-1 space-y-1">
                      <li>Real-time мониторинг</li>
                      <li>Мгновенные уведомления</li>
                      <li>Потоковые данные</li>
                    </ul>
                  </div>
                  <button 
                    onClick={handleConnectWebSocket}
                    className={`w-full py-2 rounded font-medium ${
                      integrationStatus.websocket.connected 
                        ? 'bg-green-600 text-white' 
                        : 'bg-green-600 text-white hover:bg-green-700'
                    }`}
                    disabled={integrationStatus.websocket.connected}
                  >
                    {integrationStatus.websocket.connected ? 'Активен' : 'Активировать'}
                  </button>
                </div>
              </div>
            </div>

            {/* Real-time данные */}
            {realTimeData.length > 0 && (
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-bold">Real-time данные с оборудования</h3>
                  <div className="flex items-center space-x-2">
                    <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                    <span className="text-sm text-green-600">Поток активен</span>
                  </div>
                </div>
                
                <div className="overflow-x-auto">
                  <table className="min-w-full text-sm">
                    <thead className={`${isDarkMode ? 'bg-gray-700' : 'bg-gray-100'}`}>
                      <tr>
                        <th className="px-3 py-2 text-left">Время</th>
                        <th className="px-3 py-2 text-left">Оборудование</th>
                        <th className="px-3 py-2 text-left">Температура</th>
                        <th className="px-3 py-2 text-left">Давление</th>
                        <th className="px-3 py-2 text-left">Скорость</th>
                        <th className="px-3 py-2 text-left">Вибрация</th>
                        <th className="px-3 py-2 text-left">Мощность</th>
                        <th className="px-3 py-2 text-left">Статус</th>
                      </tr>
                    </thead>
                    <tbody className={`divide-y ${isDarkMode ? 'divide-gray-700' : 'divide-gray-200'}`}>
                      {realTimeData.slice(0, 10).map((data, index) => (
                        <tr key={index} className={`${
                          data.status === 'alarm' ? 'bg-red-50' : 
                          data.status === 'warning' ? 'bg-yellow-50' : ''
                        }`}>
                          <td className="px-3 py-2">{new Date(data.timestamp).toLocaleTimeString()}</td>
                          <td className="px-3 py-2 font-medium">{data.equipment}</td>
                          <td className="px-3 py-2">
                            <span className={`${
                              data.parameters.temperature > 85 ? 'text-red-600 font-bold' :
                              data.parameters.temperature > 80 ? 'text-orange-600' : 'text-green-600'
                            }`}>
                              {data.parameters.temperature.toFixed(1)}°C
                            </span>
                          </td>
                          <td className="px-3 py-2">
                            <span className={`${
                              data.parameters.pressure > 2.8 ? 'text-red-600 font-bold' :
                              data.parameters.pressure > 2.5 ? 'text-orange-600' : 'text-green-600'
                            }`}>
                              {data.parameters.pressure.toFixed(1)} бар
                            </span>
                          </td>
                          <td className="px-3 py-2">{Math.round(data.parameters.speed)} об/мин</td>
                          <td className="px-3 py-2">
                            <span className={`${
                              data.parameters.vibration > 4 ? 'text-red-600 font-bold' :
                              data.parameters.vibration > 3 ? 'text-orange-600' : 'text-green-600'
                            }`}>
                              {data.parameters.vibration.toFixed(1)} мм/с
                            </span>
                          </td>
                          <td className="px-3 py-2">{Math.round(data.parameters.power)} кВт</td>
                          <td className="px-3 py-2">
                            <span className={`px-2 py-1 rounded text-xs font-medium ${
                              data.status === 'alarm' ? 'bg-red-100 text-red-800' :
                              data.status === 'warning' ? 'bg-yellow-100 text-yellow-800' :
                              'bg-green-100 text-green-800'
                            }`}>
                              {data.status === 'alarm' ? 'АВАРИЯ' :
                               data.status === 'warning' ? 'Предупреждение' : 'Норма'}
                            </span>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}

            {/* Параметры оборудования */}
            {Object.keys(equipmentParameters).length > 0 && (
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
                <h3 className="text-lg font-bold mb-4">Текущие параметры оборудования</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {Object.entries(equipmentParameters).map(([equipment, params]) => (
                    <div key={equipment} className={`p-4 border rounded-lg ${
                      params.status === 'alarm' ? 'border-red-500 bg-red-50' :
                      params.status === 'warning' ? 'border-yellow-500 bg-yellow-50' :
                      'border-green-500 bg-green-50'
                    }`}>
                      <div className="flex justify-between items-center mb-2">
                        <h4 className="font-semibold">{equipment}</h4>
                        <span className="text-xs text-gray-500">
                          {new Date(params.timestamp).toLocaleTimeString()}
                        </span>
                      </div>
                      <div className="grid grid-cols-2 gap-2 text-sm">
                        <div>T: {params.temperature?.toFixed(1)}°C</div>
                        <div>P: {params.pressure?.toFixed(1)} бар</div>
                        <div>V: {Math.round(params.speed)} об/мин</div>
                        <div>Вибр: {params.vibration?.toFixed(1)} мм/с</div>
                        <div className="col-span-2">Мощность: {Math.round(params.power)} кВт</div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}

        {/* Вкладка Оборудование */}
        {activeTab === 'equipment' && (
          <div className="space-y-6">
            {/* Панель управления */}
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold">Реестр оборудования</h2>
                <div className="flex space-x-2">
                  <button 
                    onClick={() => setComparisonMode(!comparisonMode)}
                    className={`px-4 py-2 rounded flex items-center space-x-2 ${
                      comparisonMode ? 'bg-green-600 text-white' : 'bg-gray-200 text-gray-700'
                    }`}
                  >
                    <Users size={16} />
                    <span>Режим сравнения</span>
                  </button>
                  <button 
                    onClick={() => setViewMode(viewMode === 'cards' ? 'table' : 'cards')}
                    className="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 flex items-center space-x-2"
                  >
                    {viewMode === 'cards' ? <BarChart2 size={16} /> : <Database size={16} />}
                    <span>{viewMode === 'cards' ? 'Таблица' : 'Карточки'}</span>
                  </button>
                  <button 
                    onClick={() => handleExport('excel', Object.values(equipmentRegistry), 'Реестр_оборудования')}
                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center space-x-2"
                  >
                    <Download size={16} />
                    <span>Экспорт</span>
                  </button>
                </div>
              </div>
              
              {/* Фильтры */}
              <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Критичность</label>
                  <select className={`w-full p-2 border rounded ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}>
                    <option value="">Все</option>
                    <option value="high">Высокая</option>
                    <option value="medium">Средняя</option>
                    <option value="low">Низкая</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Готовность</label>
                  <select className={`w-full p-2 border rounded ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}>
                    <option value="">Все</option>
                    <option value="high">95%+</option>
                    <option value="medium">85-95%</option>
                    <option value="low">&lt;85%</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Риск</label>
                  <select className={`w-full p-2 border rounded ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}>
                    <option value="">Все</option>
                    <option value="high">Высокий (70+)</option>
                    <option value="medium">Средний (40-70)</option>
                    <option value="low">Низкий (&lt;40)</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Местоположение</label>
                  <select className={`w-full p-2 border rounded ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}>
                    <option value="">Все</option>
                    <option value="shop1">Цех №1</option>
                    <option value="shop2">Цех №2</option>
                    <option value="shop3">Цех №3</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Поиск</label>
                  <div className="relative">
                    <input 
                      type="text" 
                      placeholder="Поиск по коду..."
                      className={`w-full p-2 border rounded pr-8 ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}
                    />
                    <Search className="absolute right-2 top-2 text-gray-400" size={20} />
                  </div>
                </div>
              </div>
              
              {/* Статистика */}
              <div className="grid grid-cols-4 gap-4 mt-4 text-sm">
                <div className="text-center">
                  <p className="text-gray-600">Всего</p>
                  <p className="text-2xl font-bold">{Object.keys(equipmentRegistry).length}</p>
                </div>
                <div className="text-center">
                  <p className="text-gray-600">Критичных</p>
                  <p className="text-2xl font-bold text-red-600">{criticalEquipment.length}</p>
                </div>
                <div className="text-center">
                  <p className="text-gray-600">Средняя готовность</p>
                  <p className="text-2xl font-bold text-green-600">
                    {Object.values(equipmentRegistry).length > 0 ? 
                      Math.round(Object.values(equipmentRegistry).reduce((acc, eq) => acc + eq.availability, 0) / Object.values(equipmentRegistry).length) : 0}%
                  </p>
                </div>
                <div className="text-center">
                  <p className="text-gray-600">Требуют ТО</p>
                  <p className="text-2xl font-bold text-orange-600">
                    {Object.values(equipmentRegistry).filter(eq => eq.availability < 90).length}
                  </p>
                </div>
              </div>
            </div>

            {/* Сравнение оборудования */}
            {comparisonMode && selectedEquipmentForComparison.length > 0 && (
              <EquipmentComparison />
            )}

            {/* Список оборудования */}
            {viewMode === 'cards' ? (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                {Object.values(equipmentRegistry).map(equipment => (
                  <EquipmentCard key={equipment.id} equipment={equipment} />
                ))}
              </div>
            ) : (
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-md overflow-hidden`}>
                <div className="overflow-x-auto">
                  <table className="min-w-full">
                    <thead className={`${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                      <tr>
                        {comparisonMode && <th className="px-6 py-3 text-left"></th>}
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Код</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Критичность</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Готовность</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Эффективность</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">MTBF</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">MTTR</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Риск</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">События</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Действия</th>
                      </tr>
                    </thead>
                    <tbody className={`divide-y ${isDarkMode ? 'divide-gray-700' : 'divide-gray-200'}`}>
                      {Object.values(equipmentRegistry).map(equipment => (
                        <tr key={equipment.id} className={`hover:bg-gray-50 ${isDarkMode ? 'hover:bg-gray-700' : ''}`}>
                          {comparisonMode && (
                            <td className="px-6 py-4">
                              <input 
                                type="checkbox" 
                                checked={selectedEquipmentForComparison.includes(equipment.code)}
                                onChange={() => {
                                  if (selectedEquipmentForComparison.includes(equipment.code)) {
                                    setSelectedEquipmentForComparison(prev => prev.filter(e => e !== equipment.code));
                                  } else {
                                    setSelectedEquipmentForComparison(prev => [...prev, equipment.code]);
                                  }
                                }}
                              />
                            </td>
                          )}
                          <td className="px-6 py-4 whitespace-nowrap font-medium">{equipment.code}</td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-2 py-1 rounded text-xs font-medium ${
                              equipment.criticality === 'high' ? 'bg-red-100 text-red-800' :
                              equipment.criticality === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                              'bg-green-100 text-green-800'
                            }`}>
                              {equipment.criticality === 'high' ? 'Высокая' :
                               equipment.criticality === 'medium' ? 'Средняя' : 'Низкая'}
                            </span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`font-medium ${
                              equipment.availability > 95 ? 'text-green-600' :
                              equipment.availability > 85 ? 'text-yellow-600' : 'text-red-600'
                            }`}>{equipment.availability}%</span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`font-medium ${
                              equipment.efficiency > 90 ? 'text-green-600' :
                              equipment.efficiency > 75 ? 'text-yellow-600' : 'text-red-600'
                            }`}>{equipment.efficiency}%</span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">{equipment.mtbf}ч</td>
                          <td className="px-6 py-4 whitespace-nowrap">{equipment.mttr}ч</td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`font-medium ${
                              equipment.riskScore > 70 ? 'text-red-600' :
                              equipment.riskScore > 40 ? 'text-yellow-600' : 'text-green-600'
                            }`}>{equipment.riskScore}</span>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap">{equipment.defectHistory?.length || 0}</td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="flex space-x-2">
                              <button 
                                onClick={() => {
                                  setSelectedEquipment(equipment);
                                  setShowEquipmentModal(true);
                                }}
                                className="text-blue-600 hover:text-blue-900"
                                title="Подробнее"
                              >
                                <Eye size={16} />
                              </button>
                              <button 
                                onClick={() => handleAIAnalysis(equipment)}
                                className="text-purple-600 hover:text-purple-900"
                                title="AI анализ"
                              >
                                <Brain size={16} />
                              </button>
                              <button 
                                onClick={() => handleExport('pdf', equipment, `Паспорт_${equipment.code}`)}
                                className="text-gray-600 hover:text-gray-900"
                                title="Экспорт"
                              >
                                <Download size={16} />
                              </button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            )}
            
            {Object.keys(equipmentRegistry).length === 0 && (
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-12 rounded-lg shadow-md text-center`}>
                <Wrench size={48} className="mx-auto mb-4 text-gray-400" />
                <p className="text-gray-500">Реестр оборудования пуст</p>
                <p className="text-sm text-gray-400">Загрузите данные журнала для создания реестра</p>
              </div>
            )}
          </div>
        )}

        {/* Вкладка ТО и ремонт */}
        {activeTab === 'maintenance' && (
          <div className="space-y-6">
            {/* Календарь ТО */}
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold">График технического обслуживания</h2>
                <div className="flex space-x-2">
                  <button 
                    onClick={() => handleExport('excel', maintenanceSchedule, 'График_ТО')}
                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center space-x-2"
                  >
                    <Download size={16} />
                    <span>Экспорт</span>
                  </button>
                  <button className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center space-x-2">
                    <Plus size={16} />
                    <span>Добавить ТО</span>
                  </button>
                </div>
              </div>
              
              {/* Фильтры */}
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div>
                  <label className="block text-sm font-medium mb-1">Период</label>
                  <select className={`w-full p-2 border rounded ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}>
                    <option value="week">Неделя</option>
                    <option value="month">Месяц</option>
                    <option value="quarter">Квартал</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Оборудование</label>
                  <select className={`w-full p-2 border rounded ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}>
                    <option value="">Все</option>
                    {equipmentOptions.map(eq => (
                      <option key={eq} value={eq}>{eq}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Статус</label>
                  <select className={`w-full p-2 border rounded ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}>
                    <option value="">Все</option>
                    <option value="planned">Запланировано</option>
                    <option value="in_progress">В процессе</option>
                    <option value="completed">Завершено</option>
                    <option value="overdue">Просрочено</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Приоритет</label>
                  <select className={`w-full p-2 border rounded ${isDarkMode ? 'bg-gray-700 border-gray-600' : ''}`}>
                    <option value="">Все</option>
                    <option value="high">Высокий</option>
                    <option value="medium">Средний</option>
                    <option value="low">Низкий</option>
                  </select>
                </div>
              </div>
              
              {/* Таблица графика */}
              <div className="overflow-x-auto">
                <table className="min-w-full">
                  <thead className={`${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Дата</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Оборудование</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Тип работ</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Приоритет</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Длительность</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ответственный</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Статус</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Действия</th>
                    </tr>
                  </thead>
                  <tbody className={`divide-y ${isDarkMode ? 'divide-gray-700' : 'divide-gray-200'}`}>
                    {maintenanceSchedule.slice(0, 10).map((item) => (
                      <tr key={item.id} className={`hover:bg-gray-50 ${isDarkMode ? 'hover:bg-gray-700' : ''}`}>
                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                          {new Date(item.date).toLocaleDateString()}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                          <span 
                            className="cursor-pointer hover:text-blue-600"
                            onClick={() => {
                              const equipment = equipmentRegistry[item.equipment];
                              if (equipment) {
                                setSelectedEquipment(equipment);
                                setShowEquipmentModal(true);
                              }
                            }}
                          >
                            {item.equipment}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm">{item.type}</td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            item.priority === 'Высокий' ? 'bg-red-100 text-red-800' : 
                            item.priority === 'Средний' ? 'bg-yellow-100 text-yellow-800' : 
                            'bg-green-100 text-green-800'
                          }`}>
                            {item.priority}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm">{item.estimatedDuration}ч</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm">{item.responsible}</td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            item.status === 'completed' ? 'bg-green-100 text-green-800' :
                            item.status === 'in_progress' ? 'bg-blue-100 text-blue-800' :
                            item.status === 'overdue' ? 'bg-red-100 text-red-800' :
                            'bg-gray-100 text-gray-800'
                          }`}>
                            {item.status === 'completed' ? 'Завершено' :
                             item.status === 'in_progress' ? 'В процессе' :
                             item.status === 'overdue' ? 'Просрочено' : 'Запланировано'}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm space-x-2">
                          <button className="text-blue-600 hover:text-blue-900" title="Редактировать">
                            <Edit size={14} />
                          </button>
                          <button className="text-green-600 hover:text-green-900" title="Выполнено">
                            <CheckCircle size={14} />
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              
              {maintenanceSchedule.length === 0 && (
                <div className="text-center py-12 text-gray-500">
                  <Calendar size={48} className="mx-auto mb-4 opacity-50" />
                  <p>График ТО пуст</p>
                  <p className="text-sm">Добавьте оборудование для автоматической генерации графика</p>
                </div>
              )}
            </div>

            {/* Статистика ТО */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
                <h3 className="text-lg font-semibold mb-4">Статистика ТО</h3>
                <div className="space-y-3">
                  <div className="flex justify-between">
                    <span className="text-gray-600">Запланировано:</span>
                    <span className="font-medium">{maintenanceSchedule.filter(m => m.status === 'planned').length}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">В процессе:</span>
                    <span className="font-medium text-blue-600">{maintenanceSchedule.filter(m => m.status === 'in_progress').length}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Завершено:</span>
                    <span className="font-medium text-green-600">{maintenanceSchedule.filter(m => m.status === 'completed').length}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Просрочено:</span>
                    <span className="font-medium text-red-600">{maintenanceSchedule.filter(m => m.status === 'overdue').length}</span>
                  </div>
                </div>
              </div>

              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
                <h3 className="text-lg font-semibold mb-4">Затраты на ТО</h3>
                <div className="space-y-3">
                  <div className="flex justify-between">
                    <span className="text-gray-600">Этот месяц:</span>
                    <span className="font-medium">
                      {maintenanceSchedule
                        .filter(m => new Date(m.date).getMonth() === new Date().getMonth())
                        .reduce((sum, m) => sum + (m.cost || 0), 0)
                        .toLocaleString()} ₽
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Плановые:</span>
                    <span className="font-medium text-blue-600">
                      {maintenanceSchedule
                        .filter(m => m.status === 'planned')
                        .reduce((sum, m) => sum + (m.cost || 0), 0)
                        .toLocaleString()} ₽
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Средняя стоимость:</span>
                    <span className="font-medium">
                      {maintenanceSchedule.length > 0 ? 
                        Math.round(maintenanceSchedule.reduce((sum, m) => sum + (m.cost || 0), 0) / maintenanceSchedule.length).toLocaleString() : 0} ₽
                    </span>
                  </div>
                </div>
              </div>

              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
                <h3 className="text-lg font-semibold mb-4">Эффективность ТО</h3>
                <div className="space-y-3">
                  <div className="flex justify-between">
                    <span className="text-gray-600">Выполнено вовремя:</span>
                    <span className="font-medium text-green-600">92%</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Среднее время ТО:</span>
                    <span className="font-medium">4.5 ч</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-600">Эффективность:</span>
                    <div className="flex items-center space-x-2">
                      <div className="w-20 bg-gray-200 rounded-full h-2">
                        <div className="bg-green-500 h-2 rounded-full" style={{width: '87%'}}></div>
                      </div>
                      <span className="font-medium">87%</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Вкладка Журнал */}
        {activeTab === 'log' && (
          <div className="space-y-6">
            {/* Ввод данных */}
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold">Ввод и обработка данных журнала</h2>
                <div className="flex space-x-2">
                  <input 
                    ref={fileInputRef}
                    type="file"
                    accept=".txt,.csv,.log,.xlsx,.xls"
                    onChange={handleFileUpload}
                    className="hidden"
                  />
                  <button 
                    onClick={() => fileInputRef.current?.click()}
                    className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center space-x-2"
                  >
                    <CloudUpload size={16} />
                    <span>Загрузить файл</span>
                  </button>
                  <button 
                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center space-x-2"
                    onClick={() => {
                      navigator.clipboard.readText().then(text => {
                        setLogData(text);
                        NotificationSystem.notify({
                          type: 'success',
                          title: 'Данные вставлены',
                          message: 'Данные из буфера обмена вставлены'
                        });
                      }).catch(() => {
                        NotificationSystem.notify({
                          type: 'error',
                          title: 'Ошибка',
                          message: 'Не удалось получить данные из буфера обмена'
                        });
                      });
                    }}
                  >
                    <FileText size={16} />
                    <span>Вставить из буфера</span>
                  </button>
                </div>
              </div>
              
              <div className="mb-4">
                <textarea 
                  value={logData}
                  onChange={handleLogDataChange}
                  className={`w-full h-64 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 ${
                    isDarkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'
                  } font-mono text-sm`}
                  placeholder="Вставьте журнал диспетчера здесь или загрузите файл..."
                />
              </div>
              
              <div className="flex justify-between items-center">
                <div className="flex items-center space-x-4 text-sm text-gray-600">
                  <span>Строк: {logData.split('\n').filter(l => l.trim()).length}</span>
                  <span>Символов: {logData.length}</span>
                  <span>Размер: {(new Blob([logData]).size / 1024).toFixed(1)} КБ</span>
                  {parsedData.length > 0 && (
                    <span className="text-green-600">✓ Проанализировано: {parsedData.length} событий</span>
                  )}
                </div>
                <div className="flex space-x-2">
                  <button 
                    className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
                    onClick={() => {
                      if (logData && logData.trim()) {
                        handleAnalyzeData(logData);
                        NotificationSystem.notify({
                          type: 'info',
                          title: 'Принудительный анализ',
                          message: 'Данные повторно анализируются...'
                        });
                      }
                    }}
                    title="Принудительно перезапустить анализ"
                  >
                    <RefreshCw size={14} />
                  </button>
                  <button 
                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center space-x-2"
                    onClick={() => {
                      if (logData && logData.trim()) {
                        handleAnalyzeData(logData);
                        NotificationSystem.notify({
                          type: 'success',
                          title: 'Анализ запущен',
                          message: 'Данные журнала обрабатываются...'
                        });
                      } else {
                        NotificationSystem.notify({
                          type: 'warning',
                          title: 'Нет данных',
                          message: 'Введите данные журнала для анализа'
                        });
                      }
                    }}
                  >
                    <Activity size={16} />
                    <span>Анализировать данные</span>
                  </button>
                </div>
              </div>
            </div>
            
            {/* Фильтры */}
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold">Фильтры и поиск</h2>
                <div className="flex space-x-2">
                  <button 
                    onClick={saveCurrentFilter}
                    className="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center space-x-2"
                  >
                    <Save size={14} />
                    <span>Сохранить фильтр</span>
                  </button>
                  <button 
                    onClick={resetFilters}
                    className="px-3 py-2 bg-gray-600 text-white rounded hover:bg-gray-700 flex items-center space-x-2"
                  >
                    <XCircle size={14} />
                    <span>Сбросить</span>
                  </button>
                </div>
              </div>
              
              {/* Сохраненные фильтры */}
              {savedFilters.length > 0 && (
                <div className="mb-4">
                  <label className="block text-sm font-medium mb-2">Сохраненные фильтры:</label>
                  <div className="flex flex-wrap gap-2">
                    {savedFilters.map(filter => (
                      <button
                        key={filter.id}
                        onClick={() => loadSavedFilter(filter)}
                        className="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm hover:bg-blue-200 flex items-center space-x-1"
                      >
                        <Star size={12} />
                        <span>{filter.name}</span>
                      </button>
                    ))}
                  </div>
                </div>
              )}
              
              {/* Основные фильтры */}
              <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Поиск</label>
                  <div className="relative">
                    <input 
                      type="text" 
                      placeholder="Поиск..." 
                      className={`w-full p-2 border rounded pr-8 ${
                        isDarkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'
                      }`}
                      value={filterOptions.searchText}
                      onChange={(e) => handleFilterChange('searchText', e.target.value)}
                    />
                    <Search className="absolute right-2 top-2 text-gray-400" size={20} />
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-1">Оборудование</label>
                  <select 
                    className={`w-full p-2 border rounded ${
                      isDarkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'
                    }`}
                    value={filterOptions.equipment}
                    onChange={(e) => handleFilterChange('equipment', e.target.value)}
                  >
                    <option value="">Все</option>
                    {equipmentOptions.map(equip => (
                      <option key={equip} value={equip}>{equip}</option>
                    ))}
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-1">Тип события</label>
                  <select 
                    className={`w-full p-2 border rounded ${
                      isDarkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'
                    }`}
                    value={filterOptions.eventType}
                    onChange={(e) => handleFilterChange('eventType', e.target.value)}
                  >
                    <option value="">Все</option>
                    <option value="Критический">Критический</option>
                    <option value="Высокий">Высокий</option>
                    <option value="Низкий">Низкий</option>
                    <option value="Информация">Информация</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-1">Критичность</label>
                  <select 
                    className={`w-full p-2 border rounded ${
                      isDarkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'
                    }`}
                    value={filterOptions.severity}
                    onChange={(e) => handleFilterChange('severity', e.target.value)}
                  >
                    <option value="">Все</option>
                    <option value="high">Высокая</option>
                    <option value="medium">Средняя</option>
                    <option value="low">Низкая</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-1">Дата от</label>
                  <input 
                    type="date" 
                    className={`w-full p-2 border rounded ${
                      isDarkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'
                    }`}
                    value={filterOptions.dateFrom}
                    onChange={(e) => handleFilterChange('dateFrom', e.target.value)}
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-medium mb-1">Дата до</label>
                  <input 
                    type="date" 
                    className={`w-full p-2 border rounded ${
                      isDarkMode ? 'bg-gray-700 border-gray-600 text-white' : 'bg-white border-gray-300'
                    }`}
                    value={filterOptions.dateTo}
                    onChange={(e) => handleFilterChange('dateTo', e.target.value)}
                  />
                </div>
              </div>
              
              <div className="flex justify-between items-center text-sm text-gray-600 mt-4">
                <span>
                  Показано: {filteredData.length} из {parsedData.length} записей
                  {filterOptions.searchText && (
                    <span className="ml-2 px-2 py-1 bg-blue-100 text-blue-800 rounded">
                      Поиск: "{filterOptions.searchText}"
                    </span>
                  )}
                </span>
                <button 
                  onClick={() => handleExport('excel', filteredData, 'Отфильтрованные_данные')}
                  className="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700"
                >
                  Экспорт результатов
                </button>
              </div>
            </div>
            
            {/* Таблица журнала */}
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg shadow-md overflow-hidden`}>
              <div className="overflow-x-auto">
                <table className="min-w-full">
                  <thead className={`${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'}`}>
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Дата</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Время</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Оборудование</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Тип</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Критичность</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Сообщение</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Источник</th>
                    </tr>
                  </thead>
                  <tbody className={`divide-y ${isDarkMode ? 'divide-gray-700' : 'divide-gray-200'}`}>
                    {filteredData.slice(0, 50).map((entry, index) => (
                      <tr key={index} className={`hover:bg-gray-50 ${isDarkMode ? 'hover:bg-gray-700' : ''} ${
                        entry.severity === 'high' ? 'bg-red-50' : 
                        entry.severity === 'medium' ? 'bg-yellow-50' : ''
                      }`}>
                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium">
                          {entry.date}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                          {entry.eventTime}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                          {entry.equipment ? (
                            <span 
                              className="cursor-pointer hover:text-blue-600 hover:underline"
                              onClick={() => {
                                const equipment = equipmentRegistry[entry.equipment];
                                if (equipment) {
                                  setSelectedEquipment(equipment);
                                  setShowEquipmentModal(true);
                                }
                              }}
                            >
                              {entry.equipment}
                            </span>
                          ) : '-'}
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                            entry.eventType === 'Критический' ? 'bg-red-100 text-red-800' : 
                            entry.eventType === 'Высокий' ? 'bg-orange-100 text-orange-800' : 
                            entry.eventType === 'Информация' ? 'bg-blue-100 text-blue-800' : 
                            'bg-green-100 text-green-800'
                          }`}>
                            {entry.eventType}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center space-x-2">
                            <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${
                              entry.severity === 'high' ? 'bg-red-100 text-red-800' : 
                              entry.severity === 'medium' ? 'bg-yellow-100 text-yellow-800' : 
                              'bg-green-100 text-green-800'
                            }`}>
                              {entry.severity === 'high' ? 'Высокая' : 
                               entry.severity === 'medium' ? 'Средняя' : 'Низкая'}
                            </span>
                            {entry.severity === 'high' && (
                              <AlertTriangle size={14} className="text-red-500" />
                            )}
                          </div>
                        </td>
                        <td className="px-6 py-4 text-sm max-w-xs">
                          <div className="truncate" title={entry.message}>
                            {entry.message}
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                          {entry.source}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                
                {filteredData.length === 0 && (
                  <div className="text-center py-12 text-gray-500">
                    <Search size={48} className="mx-auto mb-4 opacity-50" />
                    <p>Записи не найдены</p>
                    <p className="text-sm">Попробуйте изменить критерии поиска</p>
                  </div>
                )}
                
                {filteredData.length > 50 && (
                  <div className="p-4 text-center text-sm text-gray-600">
                    Показаны первые 50 записей из {filteredData.length}
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Вкладка Аналитика */}
        {activeTab === 'analytics' && (
          <div className="space-y-6">
            {/* Расширенная аналитика */}
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-bold">Расширенная аналитика</h2>
                <div className="flex space-x-2">
                  <button className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center space-x-2">
                    <Brain size={16} />
                    <span>ML Прогнозы</span>
                  </button>
                  <button 
                    onClick={() => handleExport('pdf', {
                      equipmentStats,
                      eventTypeStats,
                      timelineData,
                      recommendations
                    }, 'Полный_отчет_аналитики')}
                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center space-x-2"
                  >
                    <FileText size={16} />
                    <span>Полный отчет</span>
                  </button>
                </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div className="bg-blue-50 p-4 rounded">
                  <h3 className="font-semibold text-blue-800">Общая эффективность</h3>
                  <p className="text-2xl font-bold text-blue-600">
                    {Object.values(equipmentRegistry).length > 0 ? 
                      Math.round(Object.values(equipmentRegistry).reduce((acc, eq) => acc + eq.availability, 0) / Object.values(equipmentRegistry).length) : 0}%
                  </p>
                  <p className="text-sm text-blue-600">OEE (Overall Equipment Effectiveness)</p>
                </div>
                
                <div className="bg-green-50 p-4 rounded">
                  <h3 className="font-semibold text-green-800">MTBF средний</h3>
                  <p className="text-2xl font-bold text-green-600">
                    {Object.values(equipmentRegistry).length > 0 ? 
                      Math.round(Object.values(equipmentRegistry).reduce((acc, eq) => acc + eq.mtbf, 0) / Object.values(equipmentRegistry).length) : 0}ч
                  </p>
                  <p className="text-sm text-green-600">Время безотказной работы</p>
                </div>
                
                <div className="bg-orange-50 p-4 rounded">
                  <h3 className="font-semibold text-orange-800">MTTR средний</h3>
                  <p className="text-2xl font-bold text-orange-600">
                    {Object.values(equipmentRegistry).length > 0 ? 
                      Math.round(Object.values(equipmentRegistry).reduce((acc, eq) => acc + eq.mttr, 0) / Object.values(equipmentRegistry).length) : 0}ч
                  </p>
                  <p className="text-sm text-orange-600">Время восстановления</p>
                </div>
                
                <div className="bg-red-50 p-4 rounded">
                  <h3 className="font-semibold text-red-800">Риск-индекс</h3>
                  <p className="text-2xl font-bold text-red-600">
                    {criticalEquipment.length > 0 ? 
                      Math.round(criticalEquipment.reduce((acc, eq) => acc + eq.riskScore, 0) / criticalEquipment.length) : 0}
                  </p>
                  <p className="text-sm text-red-600">Средний уровень риска</p>
                </div>
              </div>
            </div>

            {/* Продвинутые графики */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Корреляционный анализ */}
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
                <h3 className="text-lg font-bold mb-4">Корреляция: Наработка vs Отказы</h3>
                <div className="h-64">
                  {Object.values(equipmentRegistry).length > 0 ? (
                    <ResponsiveContainer width="100%" height="100%">
                      <ScatterChart data={Object.values(equipmentRegistry).map(eq => ({
                        name: eq.code,
                        hours: eq.operatingHours,
                        failures: eq.defectHistory?.filter(d => d.severity === 'high').length || 0,
                        availability: eq.availability
                      }))}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis dataKey="hours" name="Наработка (ч)" />
                        <YAxis dataKey="failures" name="Отказы" />
                        <Tooltip 
                          content={({active, payload}) => {
                            if (active && payload && payload.length) {
                              const data = payload[0].payload;
                              return (
                                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-3 border rounded shadow-lg`}>
                                  <p className="font-semibold">{data.name}</p>
                                  <p>Наработка: {data.hours} ч</p>
                                  <p>Отказы: {data.failures}</p>
                                  <p>Готовность: {data.availability}%</p>
                                </div>
                              );
                            }
                            return null;
                          }}
                        />
                        <Scatter dataKey="failures" fill="#8884d8" />
                      </ScatterChart>
                    </ResponsiveContainer>
                  ) : (
                    <div className="h-full flex items-center justify-center text-gray-500">
                      Нет данных для отображения
                    </div>
                  )}
                </div>
              </div>

              {/* Радарная диаграмма */}
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
                <h3 className="text-lg font-bold mb-4">Сравнительный анализ эффективности</h3>
                <div className="h-64">
                  {Object.values(equipmentRegistry).length > 0 ? (
                    <ResponsiveContainer width="100%" height="100%">
                      <RadarChart data={Object.values(equipmentRegistry).slice(0, 6).map(eq => ({
                        equipment: eq.code,
                        availability: eq.availability,
                        reliability: Math.max(0, 100 - (eq.defectHistory?.length || 0) * 10),
                        efficiency: eq.efficiency,
                        cost: Math.max(0, 100 - (eq.maintenanceCost / 1000))
                      }))}>
                        <PolarGrid />
                        <PolarAngleAxis dataKey="equipment" />
                        <PolarRadiusAxis angle={90} domain={[0, 100]} />
                        <Radar name="Готовность" dataKey="availability" stroke="#8884d8" fill="#8884d8" fillOpacity={0.6} />
                        <Radar name="Надежность" dataKey="reliability" stroke="#82ca9d" fill="#82ca9d" fillOpacity={0.6} />
                        <Radar name="Эффективность" dataKey="efficiency" stroke="#ffc658" fill="#ffc658" fillOpacity={0.6} />
                        <Radar name="Экономичность" dataKey="cost" stroke="#ff8042" fill="#ff8042" fillOpacity={0.6} />
                        <Legend />
                      </RadarChart>
                    </ResponsiveContainer>
                  ) : (
                    <div className="h-full flex items-center justify-center text-gray-500">
                      Нет данных для отображения
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Все рекомендации */}
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
              <h3 className="text-lg font-bold mb-4">Все рекомендации</h3>
              <div className="space-y-4">
                {recommendations.map((rec, index) => (
                  <div 
                    key={index} 
                    className={`p-4 rounded-lg border-l-4 ${
                      rec.priority === 'Критический' ? 'bg-red-50 border-red-500' : 
                      rec.priority === 'Высокий' ? 'bg-orange-50 border-orange-500' : 
                      rec.priority === 'Средний' ? 'bg-yellow-50 border-yellow-500' :
                      'bg-green-50 border-green-500'
                    }`}
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex items-start space-x-3 flex-1">
                        <div className={`p-2 rounded-full ${
                          rec.priority === 'Критический' ? 'bg-red-100 text-red-700' : 
                          rec.priority === 'Высокий' ? 'bg-orange-100 text-orange-700' : 
                          rec.priority === 'Средний' ? 'bg-yellow-100 text-yellow-700' :
                          'bg-green-100 text-green-700'
                        }`}>
                          <AlertTriangle size={18} />
                        </div>
                        <div className="flex-1">
                          <div className="flex items-center space-x-2 mb-1">
                            <h3 className="font-bold">{rec.priority}</h3>
                            {rec.equipment && (
                              <span className="text-sm bg-gray-200 px-2 py-1 rounded cursor-pointer hover:bg-gray-300"
                                    onClick={() => {
                                      const equipment = equipmentRegistry[rec.equipment];
                                      if (equipment) {
                                        setSelectedEquipment(equipment);
                                        setShowEquipmentModal(true);
                                      }
                                    }}>
                                {rec.equipment}
                              </span>
                            )}
                            {rec.confidence && (
                              <span className="text-sm text-gray-600">
                                Точность: {(rec.confidence * 100).toFixed(0)}%
                              </span>
                            )}
                            {rec.source && (
                              <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                {rec.source}
                              </span>
                            )}
                          </div>
                          <p className="text-gray-800 mb-2">{rec.text}</p>
                          
                          <div className="flex flex-wrap gap-3 text-sm">
                            {rec.estimatedCost > 0 && (
                              <span className="text-gray-600">
                                💰 {rec.estimatedCost.toLocaleString()} ₽
                              </span>
                            )}
                            {rec.impact && (
                              <span className="text-gray-600">
                                📈 {rec.impact}
                              </span>
                            )}
                            {rec.timeline && (
                              <span className="text-gray-600">
                                ⏱️ {rec.timeline}
                              </span>
                            )}
                            {rec.aiPrediction && (
                              <span className="text-orange-600">
                                ⚠️ Прогноз отказа: {new Date(rec.aiPrediction.date).toLocaleDateString()}
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                      
                      <div className="flex space-x-2">
                        {rec.actionRequired && (
                          <button className="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                            Создать заявку
                          </button>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* Вкладка Настройки */}
        {activeTab === 'settings' && (
          <div className="space-y-6">
            {/* Общие настройки */}
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
              <h2 className="text-xl font-bold mb-4">Общие настройки</h2>
              <div className="space-y-4">
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="font-medium">Темная тема</h3>
                    <p className="text-sm text-gray-600">Переключение между светлой и темной темой</p>
                  </div>
                  <button 
                    onClick={() => setIsDarkMode(!isDarkMode)}
                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                      isDarkMode ? 'bg-blue-600' : 'bg-gray-300'
                    }`}
                  >
                    <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                      isDarkMode ? 'translate-x-6' : 'translate-x-1'
                    }`} />
                  </button>
                </div>
                
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="font-medium">Режим реального времени</h3>
                    <p className="text-sm text-gray-600">Автоматическая генерация событий для демонстрации</p>
                  </div>
                  <button 
                    onClick={() => setRealTimeMode(!realTimeMode)}
                    className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                      realTimeMode ? 'bg-blue-600' : 'bg-gray-300'
                    }`}
                  >
                    <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                      realTimeMode ? 'translate-x-6' : 'translate-x-1'
                    }`} />
                  </button>
                </div>
                
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="font-medium">Автосохранение</h3>
                    <p className="text-sm text-gray-600">Автоматическое сохранение данных в браузере</p>
                  </div>
                  <button className="relative inline-flex h-6 w-11 items-center rounded-full bg-blue-600">
                    <span className="inline-block h-4 w-4 transform rounded-full bg-white translate-x-6" />
                  </button>
                </div>
              </div>
            </div>

            {/* Настройки уведомлений */}
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
              <h2 className="text-xl font-bold mb-4">Уведомления</h2>
              <div className="space-y-4">
                <div>
                  <h3 className="font-medium mb-2">Критичность уведомлений</h3>
                  <div className="space-y-2">
                    <label className="flex items-center space-x-2">
                      <input type="checkbox" defaultChecked className="rounded" />
                      <span>Критические события</span>
                    </label>
                    <label className="flex items-center space-x-2">
                      <input type="checkbox" defaultChecked className="rounded" />
                      <span>Высокий приоритет</span>
                    </label>
                    <label className="flex items-center space-x-2">
                      <input type="checkbox" className="rounded" />
                      <span>Средний приоритет</span>
                    </label>
                    <label className="flex items-center space-x-2">
                      <input type="checkbox" className="rounded" />
                      <span>Информационные</span>
                    </label>
                  </div>
                </div>
                
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="font-medium">Звуковые уведомления</h3>
                    <p className="text-sm text-gray-600">Воспроизведение звука при критических событиях</p>
                  </div>
                  <button className="relative inline-flex h-6 w-11 items-center rounded-full bg-blue-600">
                    <span className="inline-block h-4 w-4 transform rounded-full bg-white translate-x-6" />
                  </button>
                </div>
              </div>
            </div>

            {/* Управление данными */}
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
              <h2 className="text-xl font-bold mb-4">Управление данными</h2>
              <div className="space-y-4">
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="font-medium">Размер локального хранилища</h3>
                    <p className="text-sm text-gray-600">
                      Использовано: {((JSON.stringify(parsedData).length + JSON.stringify(equipmentRegistry).length) / 1024).toFixed(1)} КБ
                    </p>
                  </div>
                  <button 
                    onClick={() => {
                      if (confirm('Очистить все сохраненные данные?')) {
                        StorageSystem.clear();
                        
                        NotificationSystem.notify({
                          type: 'success',
                          title: 'Данные очищены',
                          message: 'Все локальные данные удалены'
                        });
                        
                        setTimeout(() => window.location.reload(), 1000);
                      }
                    }}
                    className="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700"
                  >
                    Очистить
                  </button>
                </div>
                
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="font-medium">Резервное копирование</h3>
                    <p className="text-sm text-gray-600">Создать полную копию всех данных</p>
                  </div>
                  <button 
                    onClick={() => {
                      const backup = {
                        timestamp: new Date().toISOString(),
                        logData,
                        parsedData,
                        equipmentRegistry,
                        savedFilters,
                        recommendations,
                        maintenanceSchedule,
                        aiAnalysis
                      };
                      
                      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
                      const url = URL.createObjectURL(blob);
                      const a = document.createElement('a');
                      a.href = url;
                      a.download = `factory_backup_${new Date().toISOString().split('T')[0]}.json`;
                      a.click();
                      URL.revokeObjectURL(url);
                      
                      NotificationSystem.notify({
                        type: 'success',
                        title: 'Резервная копия создана',
                        message: 'Файл backup загружен'
                      });
                    }}
                    className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                  >
                    Создать
                  </button>
                </div>
                
                <div className="flex items-center justify-between">
                  <div>
                    <h3 className="font-medium">Восстановление</h3>
                    <p className="text-sm text-gray-600">Загрузить данные из файла резервной копии</p>
                  </div>
                  <button 
                    onClick={() => {
                      const input = document.createElement('input');
                      input.type = 'file';
                      input.accept = '.json';
                      input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                          const reader = new FileReader();
                          reader.onload = (e) => {
                            try {
                              const backup = JSON.parse(e.target.result);
                              
                              if (backup.logData) setLogData(backup.logData);
                              if (backup.parsedData) setParsedData(backup.parsedData);
                              if (backup.equipmentRegistry) setEquipmentRegistry(backup.equipmentRegistry);
                              if (backup.savedFilters) setSavedFilters(backup.savedFilters);
                              if (backup.recommendations) setRecommendations(backup.recommendations);
                              if (backup.maintenanceSchedule) setMaintenanceSchedule(backup.maintenanceSchedule);
                              if (backup.aiAnalysis) setAiAnalysis(backup.aiAnalysis);
                              
                              NotificationSystem.notify({
                                type: 'success',
                                title: 'Данные восстановлены',
                                message: 'Резервная копия успешно загружена'
                              });
                            } catch (error) {
                              NotificationSystem.notify({
                                type: 'error',
                                title: 'Ошибка восстановления',
                                message: 'Неверный формат файла'
                              });
                            }
                          };
                          reader.readAsText(file);
                        }
                      };
                      input.click();
                    }}
                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                  >
                    Загрузить
                  </button>
                </div>
              </div>
            </div>

            {/* Информация о системе */}
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-6 rounded-lg shadow-md`}>
              <h2 className="text-xl font-bold mb-4">Информация о системе</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <h3 className="font-medium mb-2">Версия приложения</h3>
                  <p className="text-sm text-gray-600 mb-4">ЗаводАналитикс Pro v3.0.0</p>
                  
                  <h3 className="font-medium mb-2">Статистика использования</h3>
                  <div className="space-y-1 text-sm">
                    <div className="flex justify-between">
                      <span>Записей обработано:</span>
                      <span>{parsedData.length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span>Оборудования в реестре:</span>
                      <span>{Object.keys(equipmentRegistry).length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span>AI анализов выполнено:</span>
                      <span>{Object.keys(aiAnalysis).length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span>Сохраненных фильтров:</span>
                      <span>{savedFilters.length}</span>
                    </div>
                  </div>
                </div>
                
                <div>
                  <h3 className="font-medium mb-2">Техническая поддержка</h3>
                  <div className="space-y-2 text-sm">
                    <p>Email: support@factoryanalytics.ru</p>
                    <p>Телефон: +7 (495) 123-45-67</p>
                    <p>Документация: docs.factoryanalytics.ru</p>
                  </div>
                  
                  <div className="mt-4 space-y-2">
                    <button className="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                      Проверить обновления
                    </button>
                    <button className="w-full px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">
                      Отправить отзыв
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
      </main>

      {/* Модальные окна */}
      {showEquipmentModal && selectedEquipment && (
        <EquipmentModal 
          equipment={selectedEquipment} 
          onClose={() => {
            setShowEquipmentModal(false);
            setSelectedEquipment(null);
          }} 
        />
      )}
    </div>
  );
};

export default EnhancedFactoryAnalyzer;
